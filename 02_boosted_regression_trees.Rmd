---
title: "02_boosted_regression_trees"
author: "Peter Flood"
date: "2024-03-12"
output:
  html_document:
    toc: yes
    df_print: paged
  html_notebook:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
getwd()
```

#Install Libraries
```{r}
# Install libraries if needed

# Need to install one from GitHub
if (!require("devtools")) install.packages("devtools")
library(devtools)
devtools::install_github("JBjouffray/ggBRT")
#
if (!require("dismo")) install.packages("dismo")
if (!require("gbm")) install.packages("gbm")
if (!require("openxlsx")) install.packages("openxlsx")
if (!require("tidyverse")) install.packages("tidyverse")
```

#Load Libraries
```{r}
library(dismo) #Boosted regression tree (BRT) modeling
library(gbm) #BRT modeling
library(ggBRT) #BRT plots and summarization
library(openxlsx) #Reading and writing Excel files
library(tidyverse) #Data management, plotting
library(ggpubr) #multipanel figures
```

#Load raw data
```{r}
all.grow.merge <- read.xlsx("~/GitHub/EAGER_growth/Outputs/all_grow_lake_join.xlsx") 
levels(as.factor(all.grow.merge$species)) #common names of all species in the data set

#Sample sizes per species per age class
sample.sizes <- all.grow.merge %>% 
  group_by(species, age_group) %>% 
  tally() %>% 
  pivot_wider(names_from = age_group, values_from = n)

write.csv(sample.sizes, 
          file = "~/GitHub/EAGER_growth/Outputs/species_age_class_sample_sizes.csv", 
          row.names = F)
```
#Boosted Regression Tree models
These are grouped by species with different age classes within each species

###Age 0 predictor vector
```{r}
age0.preds <- c(18, 20:23, 26, 33, 34, 36, 37)
```

###Pumpkinseed Sunfish

Filter for Pumpkinseed Sunfish (Lepomis gibbosus)
```{r}
psf.grow <- all.grow.merge %>%  #read.xlsx("psf_grow_3_13_23.xlsx") %>% 
  filter(species == "pumpkinseed_sunfish", !is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(lakename = as.factor(lakename), #change each of these variables from class character to factor
         county = as.factor(county),
         begin_date_month = as.factor(begin_date_month)) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
psf.age.group.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```

######Age 0

BRT model
```{r}
# sample size is too small, n = 35
# psf0_brt <- gbm.step(data = psf.grow %>% filter(age_group == 0), # data frame with rows of observations and columns of values
#                      gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
#                      gbm.y = 9, # column number with response variable
#                      family = "gaussian", # distribution of response variable
#                      tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
#                      learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#                      bag.fraction = 0.50)  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.

```

######Age 1
BRT model
```{r}
psf1_brt <- gbm.step(data=psf.grow %>% filter(age_group == 1), # data frame with rows of observations and columns of values
                    gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100, max.trees = 1000000, tolerance = 0.001)

```

Partial dependency plot
```{r}
gbm.plot(psf1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(psf1_brt)
```
Relative influence plot
```{r}
ggInfluence(psf1_brt)
```
Check model simplification
```{r}
psf1.simp <- gbm.simplify(psf1_brt, n.drops = 5)
```
Simplified BRT
```{r}
psf1.brt.simp <- gbm.step(data=psf.grow %>% filter(age_group == 1), # data frame with rows of observations and columns of values
                    gbm.x = psf1.simp$pred.list[[1]], # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100, max.trees = 1000000, tolerance = 0.001)
```

Plots simplified model
```{r}
gbm.plot(psf1.brt.simp)
ggPerformance(psf1.brt.simp)
ggInfluence(psf1.brt.simp)

```

Interactive effects among predictors
```{r}
psf1.interactions <- gbm.interactions(psf1_brt)
psf1.interactions$interactions
psf1.interactions$rank.list


```

######Age 2
BRT model
```{r}
psf2_brt <- gbm.step(data=psf.grow %>% filter(age_group == 2), # data frame with rows of observations and columns of values
                    gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100,
                    max.trees = 1000000, tolerance = 0.001)
```

Partial dependency plot
```{r}
gbm.plot(psf2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(psf2_brt)
```
Relative influence plot
```{r}
ggInfluence(psf2_brt)
```
Interactive effects among predictors
```{r}
psf2.interactions <- gbm.interactions(psf2_brt)
psf2.interactions$interactions
psf2.interactions$rank.list
```
Interaction Plots
```{r}
#gbm.perspec(psf2_brt, 11, 10)
```

######Age 3
BRT model
```{r}
psf3_brt <- gbm.step(data=psf.grow %>% filter(age_group == 3), # data frame with rows of observations and columns of values
                    gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100,
                    max.trees = 1000000, tolerance = 0.001)
```

Partial dependency plot
```{r}
gbm.plot(psf3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(psf3_brt)
```
Relative influence plot
```{r}
ggInfluence(psf3_brt)
```
Interactive effects among predictors
```{r}
psf3.interactions <- gbm.interactions(psf3_brt)
psf3.interactions$interactions
psf3.interactions$rank.list


```

######Age 4
BRT model
```{r}
psf4_brt <- gbm.step(data=psf.grow %>% filter(age_group == 4), # data frame with rows of observations and columns of values
                    gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100,
                    max.trees = 1000000, tolerance = 0.001)
```

Partial dependency plot
```{r}
gbm.plot(psf4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(psf4_brt)
```
Relative influence plot
```{r}
ggInfluence(psf4_brt)
```
Interactive effects among predictors
```{r}
psf4.interactions <- gbm.interactions(psf4_brt)
psf4.interactions$interactions
psf4.interactions$rank.list


```

######Age 5
BRT model
```{r}
psf5_brt <- gbm.step(data=psf.grow %>% filter(age_group == 5), # data frame with rows of observations and columns of values
                    gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100,
                    max.trees = 1000000, tolerance = 0.001)
```

Partial dependency plot
```{r}
gbm.plot(psf5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(psf5_brt)
```
Relative influence plot
```{r}
ggInfluence(psf5_brt)
```
Interactive effects among predictors
```{r}
psf5.interactions <- gbm.interactions(psf5_brt)
psf5.interactions$interactions
psf5.interactions$rank.list
```

######Age 6
BRT model
```{r}
psf6_brt <- gbm.step(data=psf.grow %>% filter(age_group == 6), # data frame with rows of observations and columns of values
                    gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100,
                    max.trees = 1000000, tolerance = 0.001)

```

Partial dependency plot
```{r}
gbm.plot(psf6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(psf6_brt)
```
Relative influence plot
```{r}
ggInfluence(psf6_brt)
```
Interactive effects among predictors
```{r}
psf6.interactions <- gbm.interactions(psf6_brt)
psf6.interactions$interactions
psf6.interactions$rank.list
```

######Age 7
BRT model
```{r}
psf7_brt <- gbm.step(data=psf.grow %>% filter(age_group == 7), # data frame with rows of observations and columns of values
                    gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100,
                    max.trees = 1000000, tolerance = 0.001)

```

Partial dependency plot
```{r}
gbm.plot(psf7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(psf7_brt)
```
Relative influence plot
```{r}
ggInfluence(psf7_brt)
```
Interactive effects among predictors
```{r}
psf7.interactions <- gbm.interactions(psf7_brt)
psf7.interactions$interactions
psf7.interactions$rank.list
```

######Age 8
BRT model
```{r}
psf8_brt <- gbm.step(data=psf.grow %>% filter(age_group == 8), # data frame with rows of observations and columns of values
                    gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100,
                    max.trees = 1000000, tolerance = 0.001)

```

Partial dependency plot
```{r}
gbm.plot(psf8_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(psf8_brt)
```
Relative influence plot
```{r}
ggInfluence(psf8_brt)
```
Interactive effects among predictors
```{r}
psf8.interactions <- gbm.interactions(psf8_brt)
psf8.interactions$interactions
psf8.interactions$rank.list
```

######Age 9
BRT model
```{r}
psf9_brt <- gbm.step(data=psf.grow %>% filter(age_group == 9), # data frame with rows of observations and columns of values
                    gbm.x = psf.age.group.preds, # vector of column numbers of explanatory variables
                    gbm.y = 6, # column number with response variable
                    family = "gaussian", # distribution of response variable
                    tree.complexity = 5, # range 1-5, 1 being the least complex and runs fastest
                    learning.rate = 0.001, # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
                    bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets .75 is good.
                    n.folds = 10, n.trees = 50, step.size = 100,
                    max.trees = 1000000, tolerance = 0.001)

```

Partial dependency plot
```{r}
gbm.plot(psf9_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(psf9_brt)
```
Relative influence plot
```{r}
ggInfluence(psf9_brt)
```
Interactive effects among predictors
```{r}
psf9.interactions <- gbm.interactions(psf9_brt)
psf9.interactions$interactions
psf9.interactions$rank.list
```

###Combined Plots

######Format fitted functions
```{r}
psf.response.matrix <- bind_rows(
  bind_rows(
    #age group 1
  gbm::plot.gbm(psf1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(psf1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(psf1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(psf1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(psf1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(psf1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(psf1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(psf1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(psf1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(psf1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(psf2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(psf2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(psf2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(psf2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(psf2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(psf2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(psf2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(psf2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(psf2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(psf2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(psf3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(psf3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(psf3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(psf3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(psf3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(psf3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(psf3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(psf3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(psf3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(psf3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(psf4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(psf4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(psf4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(psf4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(psf4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(psf4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(psf4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(psf4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(psf4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(psf4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 1
  gbm::plot.gbm(psf5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(psf5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(psf5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(psf5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(psf5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(psf5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(psf5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(psf5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(psf5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(psf5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(psf6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(psf6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(psf6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(psf6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(psf6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(psf6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(psf6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(psf6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(psf6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(psf6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(psf7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(psf7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(psf7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(psf7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(psf7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(psf7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(psf7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(psf7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(psf7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(psf7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 7),
  bind_rows(
    #age group 1
  gbm::plot.gbm(psf8_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(psf8_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(psf8_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(psf8_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(psf8_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(psf8_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(psf8_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(psf8_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(psf8_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(psf8_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 8),
  bind_rows(
    #age group 1
  gbm::plot.gbm(psf9_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(psf9_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(psf9_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(psf9_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(psf9_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(psf9_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(psf9_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(psf9_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(psf9_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(psf9_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 9)
) %>% mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name == "DD_mean" ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
psf.rel.inf <- bind_rows(
  psf1_brt$contributions %>% mutate(Age_Group = 1),
  psf2_brt$contributions %>% mutate(Age_Group = 2),
  psf3_brt$contributions %>% mutate(Age_Group = 3),
  psf4_brt$contributions %>% mutate(Age_Group = 4),
  psf5_brt$contributions %>% mutate(Age_Group = 5),
  psf6_brt$contributions %>% mutate(Age_Group = 6),
  psf7_brt$contributions %>% mutate(Age_Group = 7),
  psf8_brt$contributions %>% mutate(Age_Group = 8),
  psf9_brt$contributions %>% mutate(Age_Group = 9)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var == "DD_mean" ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.psf.rel.inf <- psf.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

psf.response.matrix.rel.inf <- psf.response.matrix %>% 
  left_join(mean.psf.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(psf.partial.plot <- ggplot(psf.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
  labs(y = "Fitted Function", x = "Predictor Values")+
  scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/psf_partial_dependency.tiff",
       psf.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(psf.rel.inf.plot <- ggplot(psf.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/length(psf.age.group.preds))*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
  
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/psf_rel_inf.tiff",
       psf.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

###Walleye

Filter for Walleye (Sander vitreus)
```{r}
wae.grow <- all.grow.merge %>% 
  filter(species == "walleye", !is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(lakename = as.factor(lakename), #change each of these variables from class character to factor
         county = as.factor(county),
         begin_date_month = as.factor(begin_date_month))

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(wae.grow) #inspect column names
wae.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39) #create vector with desired predictors
```

######Age 0
BRT model
```{r}
wae0_brt <- gbm.step(data=wae.grow %>% filter(age_group == 0), # data frame with rows of observations and columns of values
                     gbm.x = age0.preds, 
                     gbm.y = 6, # column number with response variable
                     family = "gaussian", # distribution of response variable
                     tree.complexity = 5, # range 0-5, 0 being the least complex and runs fastest
                     learning.rate = 0.1, # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
                     bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
                     n.folds = 10,
                     n.trees = 50,
                     step.size = 1000,
                     max.trees = 1000000,
                     tolerance = 0.001
                     )

```

Partial dependency plot
```{r}
gbm.plot(wae0_brt)
```

Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae0_brt)
```

Relative influence plot
```{r}
ggInfluence(wae0_brt)
```
Interactive effects among predictors
```{r}
wae0.interactions <- gbm.interactions(wae0_brt)
wae0.interactions$interactions
wae0.interactions$rank.list
```

######Age 1
BRT model
```{r}
wae1_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 1000,
    max.trees = 1000000,
    tolerance = 0.001
    
  )
```

Partial dependency plot
```{r}
gbm.plot(wae1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae1_brt)
```
Relative influence plot
```{r}
ggInfluence(wae1_brt)
```
Interactive effects among predictors
```{r}
wae1.interactions <- gbm.interactions(wae1_brt)
wae1.interactions$interactions
wae1.interactions$rank.list
```

######Age 2
BRT model
```{r}
wae2_brt <- gbm.step(
  data = wae.grow %>% filter(age_group == 2),
  # data frame with rows of observations and columns of values
  gbm.x = wae.grow.preds,
  # vector of column numbers of explanatory variables
  gbm.y = 6,
  # column number with response variable
  family = "gaussian",
  # distribution of response variable
  tree.complexity = 5,
  # range 0-5, 0 being the least complex and runs fastest
  learning.rate = 0.1,
  # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
  bag.fraction = 0.5,
  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
  n.folds = 10,
  n.trees = 50,
  step.size = 1000,
  max.trees = 1000000,
  tolerance = 0.001
)

```

Partial dependency plot
```{r}
gbm.plot(wae2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae2_brt)
```
Relative influence plot
```{r}
ggInfluence(wae2_brt)
```
Interactive effects among predictors
```{r}
wae2.interactions <- gbm.interactions(wae2_brt)
wae2.interactions$interactions
wae2.interactions$rank.list
```

######Age 3
BRT model
```{r}
wae3_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 1000,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae3_brt)
```
Relative influence plot
```{r}
ggInfluence(wae3_brt)
```
Interactive effects among predictors
```{r}
wae3.interactions <- gbm.interactions(wae3_brt)
wae3.interactions$interactions
wae3.interactions$rank.list
```

######Age 4
BRT model
```{r}
wae4_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae4_brt)
```
Relative influence plot
```{r}
ggInfluence(wae4_brt)
```
Interactive effects among predictors
```{r}
wae4.interactions <- gbm.interactions(wae4_brt)
wae4.interactions$interactions
wae4.interactions$rank.list
```

######Age 5
BRT model
```{r}
wae5_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae5_brt)
```
Relative influence plot
```{r}
ggInfluence(wae5_brt)
```
Interactive effects among predictors
```{r}
wae5.interactions <- gbm.interactions(wae5_brt)
wae5.interactions$interactions
wae5.interactions$rank.list
```
######Age 6
BRT model
```{r}
wae6_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 6),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae6_brt)
```
Relative influence plot
```{r}
ggInfluence(wae6_brt)
```
Interactive effects among predictors
```{r}
wae6.interactions <- gbm.interactions(wae6_brt)
wae6.interactions$interactions
wae6.interactions$rank.list
```
######Age 7
BRT model
```{r}
wae7_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 7),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae7_brt)
```
Relative influence plot
```{r}
ggInfluence(wae7_brt)
```
Interactive effects among predictors
```{r}
wae7.interactions <- gbm.interactions(wae7_brt)
wae7.interactions$interactions
wae7.interactions$rank.list
```

######Age 8
BRT model
```{r}
wae8_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 8),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae8_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae8_brt)
```
Relative influence plot
```{r}
ggInfluence(wae8_brt)
```
Interactive effects among predictors
```{r}
wae8.interactions <- gbm.interactions(wae8_brt)
wae8.interactions$interactions
wae8.interactions$rank.list
```

######Age 9
BRT model
```{r}
wae9_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 9),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae9_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae9_brt)
```
Relative influence plot
```{r}
ggInfluence(wae9_brt)
```
Interactive effects among predictors
```{r}
wae9.interactions <- gbm.interactions(wae9_brt)
wae9.interactions$interactions
wae9.interactions$rank.list
```

######Age 10
BRT model
```{r}
wae10_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 10),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae10_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae10_brt)
```
Relative influence plot
```{r}
ggInfluence(wae10_brt)
```
Interactive effects among predictors
```{r}
wae10.interactions <- gbm.interactions(wae10_brt)
wae10.interactions$interactions
wae10.interactions$rank.list
```

######Age 11
BRT model
```{r}
wae11_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 11),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae11_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae11_brt)
```
Relative influence plot
```{r}
ggInfluence(wae11_brt)
```
Interactive effects among predictors
```{r}
wae11.interactions <- gbm.interactions(wae11_brt)
wae11.interactions$interactions
wae11.interactions$rank.list
```

######Age 12
BRT model
```{r}
wae12_brt <-
  gbm.step(
    data = wae.grow %>% filter(age_group == 12),
    # data frame with rows of observations and columns of values
    gbm.x = wae.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(wae12_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(wae12_brt)
```
Relative influence plot
```{r}
ggInfluence(wae12_brt)
```
Interactive effects among predictors
```{r}
wae12.interactions <- gbm.interactions(wae12_brt)
wae12.interactions$interactions
wae12.interactions$rank.list
```


###Combined Plots

######Format fitted functions
```{r}
wae.response.matrix <- bind_rows(
  #age group 0
  bind_rows(
  gbm::plot.gbm(wae0_brt,i.var = "dd_year", return.grid = TRUE) %>%
    rename(Predictor_Value = dd_year) %>%
    mutate(Predictor_Name = "dd_year",
           y = scale(y)),
  gbm::plot.gbm(wae0_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>%
    rename(Predictor_Value = mean_secchi_m) %>%
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae0_brt,i.var = "urban", return.grid = TRUE) %>%
    rename(Predictor_Value = urban) %>%
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae0_brt,i.var = "agriculture", return.grid = TRUE) %>%
    rename(Predictor_Value = agriculture) %>%
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae0_brt,i.var = "forests", return.grid = TRUE) %>%
    rename(Predictor_Value = forests) %>%
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae0_brt,i.var = "wetlands", return.grid = TRUE) %>%
    rename(Predictor_Value = wetlands) %>%
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae0_brt,i.var = "doy", return.grid = TRUE) %>%
    rename(Predictor_Value = doy) %>%
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae0_brt,i.var = "log_max_depth", return.grid = TRUE) %>%
    rename(Predictor_Value = log_max_depth) %>%
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae0_brt,i.var = "logarea", return.grid = TRUE) %>%
    rename(Predictor_Value = logarea) %>%
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae0_brt,i.var = "surf_temp_year", return.grid = TRUE) %>%
    rename(Predictor_Value = surf_temp_year) %>%
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 0),
  #age group 1
  bind_rows(
  gbm::plot.gbm(wae1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(wae2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(wae3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(wae4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 5
  gbm::plot.gbm(wae5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y)),
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(wae6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y)),
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(wae7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y)),
  ) %>% mutate(Age_Group = 7),
  bind_rows(
    #age group 8
  gbm::plot.gbm(wae8_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae8_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae8_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae8_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae8_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae8_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae8_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae8_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae8_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae8_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y)),
  ) %>% mutate(Age_Group = 8),
  bind_rows(
    #age group 9
  gbm::plot.gbm(wae9_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae9_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae9_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae9_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae9_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae9_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae9_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae9_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae9_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae9_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y)),
  ) %>% mutate(Age_Group = 9),
  bind_rows(
    #age group 10
  gbm::plot.gbm(wae10_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae10_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae10_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae10_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae10_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae10_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae10_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae10_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae10_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae10_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y)),
  ) %>% mutate(Age_Group = 10),
  bind_rows(
    #age group 11
  gbm::plot.gbm(wae11_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae11_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae11_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae11_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae11_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae11_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae11_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae11_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae11_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae11_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y)),
  ) %>% mutate(Age_Group = 11),
  bind_rows(
    #age group 12
  gbm::plot.gbm(wae12_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(wae12_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(wae12_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(wae12_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(wae12_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(wae12_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(wae12_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(wae12_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(wae12_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(wae12_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y)),
  ) %>% mutate(Age_Group = 12)
  ) %>% 
    mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name %in% c("DD_mean", "dd_year") ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
wae.rel.inf <- bind_rows(
  wae0_brt$contributions %>% mutate(Age_Group = 0),
  wae1_brt$contributions %>% mutate(Age_Group = 1),
  wae2_brt$contributions %>% mutate(Age_Group = 2),
  wae3_brt$contributions %>% mutate(Age_Group = 3),
  wae4_brt$contributions %>% mutate(Age_Group = 4),
  wae5_brt$contributions %>% mutate(Age_Group = 5),
  wae6_brt$contributions %>% mutate(Age_Group = 6),
  wae7_brt$contributions %>% mutate(Age_Group = 7),
  wae8_brt$contributions %>% mutate(Age_Group = 8),
  wae9_brt$contributions %>% mutate(Age_Group = 9),
  wae10_brt$contributions %>% mutate(Age_Group = 10),
  wae11_brt$contributions %>% mutate(Age_Group = 11),
  wae12_brt$contributions %>% mutate(Age_Group = 12)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var %in% c("DD_mean", "dd_year") ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "logcounty" ~ "County Population",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.wae.rel.inf <- wae.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

wae.response.matrix.rel.inf <- wae.response.matrix %>% 
  left_join(mean.wae.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(wae.partial.plot <- ggplot(wae.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
  labs(y = "Fitted Function", x = "Predictor Values")+
  scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/wae_partial_dependency.tiff",
       wae.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(wae.rel.inf.plot <- ggplot(wae.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/wae_rel_inf.tiff",
       wae.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```


###Rock Bass
Filter for Rock Bass (Ambloplites rupestris)
```{r}
rb.grow <- all.grow.merge %>% 
  filter(species == "rock_bass", !is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(lakename = as.factor(lakename), #change each of these variables from class character to factor
         county = as.factor(county),
         begin_date_month = as.factor(begin_date_month)) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(rb.grow) #inspect column names
rb.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)#create vector with desired predictors

```
######Age 0
BRT model
```{r}
# n = 12, sample size is too small
# rb0_brt <- gbm.step(data=rb.grow %>% filter(age_group == 0), # data frame with rows of observations and columns of values
#                      gbm.x = rb.grow.preds, # vector of column numbers of explanatory variables
#                      gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.01,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
#     bag.fraction = 0.75,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 10,
#     max.trees = 1000000,
#     tolerance = 0.001
# 
#   )

```

######Age 1
BRT model
```{r}
rb1_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(rb1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb1_brt)
```
Relative influence plot
```{r}
ggInfluence(rb1_brt)
```
Interactive effects among predictors
```{r}
rb1.interactions <- gbm.interactions(rb1_brt)
rb1.interactions$interactions
rb1.interactions$rank.list
```

######Age 2
BRT model
```{r}
rb2_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(rb2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb2_brt)
```
Relative influence plot
```{r}
ggInfluence(rb2_brt)
```
Interactive effects among predictors
```{r}
rb2.interactions <- gbm.interactions(rb2_brt)
rb2.interactions$interactions
rb2.interactions$rank.list
```

######Age 3
BRT model
```{r}
rb3_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(rb3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb3_brt)
```
Relative influence plot
```{r}
ggInfluence(rb3_brt)
```
Interactive effects among predictors
```{r}
rb3.interactions <- gbm.interactions(rb3_brt)
rb3.interactions$interactions
rb3.interactions$rank.list
```

######Age 4
BRT model
```{r}
rb4_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(rb4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb4_brt)
```
Relative influence plot
```{r}
ggInfluence(rb4_brt)
```
Interactive effects among predictors
```{r}
rb4.interactions <- gbm.interactions(rb4_brt)
rb4.interactions$interactions
rb4.interactions$rank.list
```

######Age 5
BRT model
```{r}
rb5_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(rb5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb5_brt)
```
Relative influence plot
```{r}
ggInfluence(rb5_brt)
```
Interactive effects among predictors
```{r}
rb5.interactions <- gbm.interactions(rb5_brt)
rb5.interactions$interactions
rb5.interactions$rank.list
```

######Age 6
BRT model
```{r}
rb6_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 6),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(rb6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb6_brt)
```
Relative influence plot
```{r}
ggInfluence(rb6_brt)
```

Interactive effects among predictors
```{r}
rb6.interactions <- gbm.interactions(rb6_brt)
rb6.interactions$interactions
rb6.interactions$rank.list
```

######Age 7
BRT model
```{r}
rb7_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 7),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(rb7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb7_brt)
```
Relative influence plot
```{r}
ggInfluence(rb7_brt)
```
Interactive effects among predictors
```{r}
rb7.interactions <- gbm.interactions(rb7_brt)
rb7.interactions$interactions
rb7.interactions$rank.list
```

######Age 8
BRT model
```{r}
rb8_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 8),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 50,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(rb8_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb8_brt)
```
Relative influence plot
```{r}
ggInfluence(rb8_brt)
```
Interactive effects among predictors
```{r}
rb8.interactions <- gbm.interactions(rb8_brt)
rb8.interactions$interactions
rb8.interactions$rank.list
```

######Age 9
BRT model
```{r}
rb9_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 9),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(rb9_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb9_brt)
```
Relative influence plot
```{r}
ggInfluence(rb9_brt)
```
Interactive effects among predictors
```{r}
rb9.interactions <- gbm.interactions(rb9_brt)
rb9.interactions$interactions
rb9.interactions$rank.list

```

######Age 10
BRT model
```{r}
rb10_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 10),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(rb10_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb10_brt)
```
Relative influence plot
```{r}
ggInfluence(rb10_brt)
```
Interactive effects among predictors
```{r}
rb10.interactions <- gbm.interactions(rb10_brt)
rb10.interactions$interactions
rb10.interactions$rank.list

```
######Age 11
BRT model
```{r}
rb11_brt <-
  gbm.step(
    data = rb.grow %>% filter(age_group == 11),
    # data frame with rows of observations and columns of values
    gbm.x = rb.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 11,
    n.trees = 50,
    step.size = 110,
    max.trees = 1100000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(rb11_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(rb11_brt)
```
Relative influence plot
```{r}
ggInfluence(rb11_brt)
```
Interactive effects among predictors
```{r}
rb11.interactions <- gbm.interactions(rb11_brt)
rb11.interactions$interactions
rb11.interactions$rank.list

```


###Combined Plots

######Format fitted functions
```{r}
rb.response.matrix <- bind_rows(
  bind_rows(
    #age group 1
  gbm::plot.gbm(rb1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(rb2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(rb3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(rb4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 5
  gbm::plot.gbm(rb5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(rb6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(rb7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 7),
  bind_rows(
    #age group 8
  gbm::plot.gbm(rb8_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb8_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb8_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb8_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb8_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb8_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb8_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb8_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb8_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb8_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 8),
  bind_rows(
    #age group 9
  gbm::plot.gbm(rb9_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb9_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb9_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb9_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb9_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb9_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb9_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb9_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb9_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb9_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 9),
  bind_rows(
    #age group 10
  gbm::plot.gbm(rb10_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb10_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb10_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb10_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb10_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb10_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb10_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb10_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb10_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb10_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 10),
  bind_rows(
    #age group 11
  gbm::plot.gbm(rb11_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(rb11_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(rb11_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(rb11_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(rb11_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(rb11_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(rb11_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(rb11_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(rb11_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(rb11_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 11)
) %>% mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name == "DD_mean" ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```
######Format relative influence
```{r}
rb.rel.inf <- bind_rows(
  rb1_brt$contributions %>% mutate(Age_Group = 1),
  rb2_brt$contributions %>% mutate(Age_Group = 2),
  rb3_brt$contributions %>% mutate(Age_Group = 3),
  rb4_brt$contributions %>% mutate(Age_Group = 4),
  rb5_brt$contributions %>% mutate(Age_Group = 5),
  rb6_brt$contributions %>% mutate(Age_Group = 6),
  rb7_brt$contributions %>% mutate(Age_Group = 7),
  rb8_brt$contributions %>% mutate(Age_Group = 8),
  rb9_brt$contributions %>% mutate(Age_Group = 9),
  rb10_brt$contributions %>% mutate(Age_Group = 10),
  rb11_brt$contributions %>% mutate(Age_Group = 11)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var == "DD_mean" ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "LAT_DD" ~ "Latitude",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Latitude", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.rb.rel.inf <- rb.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

rb.response.matrix.rel.inf <- rb.response.matrix %>% 
  left_join(mean.rb.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(rb.partial.plot <- ggplot(rb.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
  labs(y = "Fitted Function", x = "Predictor Values")+
  scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/rb_partial_dependency.tiff",
       rb.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(rb.rel.inf.plot <- ggplot(rb.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
  
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/rb_rel_inf.tiff",
       rb.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```



###Black Crappie

Filter for Black Crappie (Pomoxis nigromaculatus) 
```{r}
bc.grow <- all.grow.merge %>%
  filter(species == "black_crappie",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(bc.grow) #inspect column names
bc.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
bc0_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 0),
    # data frame with rows of observations and columns of values
    gbm.x = age0.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(bc0_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc0_brt)
```
Relative influence plot
```{r}
ggInfluence(bc0_brt)
```
Interactive effects among predictors
```{r}
bc0.interactions <- gbm.interactions(bc0_brt)
bc0.interactions$interactions
bc0.interactions$rank.list

```

######Age 1
BRT model
```{r}
bc1_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(bc1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc1_brt)
```
Relative influence plot
```{r}
ggInfluence(bc1_brt)
```
Interactive effects among predictors
```{r}
bc1.interactions <- gbm.interactions(bc1_brt)
bc1.interactions$interactions
bc1.interactions$rank.list

```

######Age 2
BRT model
```{r}
bc2_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(bc2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc2_brt)
```
Relative influence plot
```{r}
ggInfluence(bc2_brt)
```
Interactive effects among predictors
```{r}
bc2.interactions <- gbm.interactions(bc2_brt)
bc2.interactions$interactions
bc2.interactions$rank.list

```

######Age 3
BRT model
```{r}
bc3_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(bc3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc3_brt)
```
Relative influence plot
```{r}
ggInfluence(bc3_brt)
```
Interactive effects among predictors
```{r}
bc3.interactions <- gbm.interactions(bc3_brt)
bc3.interactions$interactions
bc3.interactions$rank.list

```

######Age 4
BRT model
```{r}
bc4_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(bc4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc4_brt)
```
Relative influence plot
```{r}
ggInfluence(bc4_brt)
```
Interactive effects among predictors
```{r}
bc4.interactions <- gbm.interactions(bc4_brt)
bc4.interactions$interactions
bc4.interactions$rank.list

```

######Age 5
BRT model
```{r}
bc5_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(bc5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc5_brt)
```
Relative influence plot
```{r}
ggInfluence(bc5_brt)
```
Interactive effects among predictors
```{r}
bc5.interactions <- gbm.interactions(bc5_brt)
bc5.interactions$interactions
bc5.interactions$rank.list

```

######Age 6
BRT model
```{r}
bc6_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 6),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(bc6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc6_brt)
```
Relative influence plot
```{r}
ggInfluence(bc6_brt)
```
Interactive effects among predictors
```{r}
bc6.interactions <- gbm.interactions(bc6_brt)
bc6.interactions$interactions
bc6.interactions$rank.list

```

######Age 7
BRT model
```{r}
bc7_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 7),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(bc7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc7_brt)
```
Relative influence plot
```{r}
ggInfluence(bc7_brt)
```
Interactive effects among predictors
```{r}
bc7.interactions <- gbm.interactions(bc7_brt)
bc7.interactions$interactions
bc7.interactions$rank.list

```

######Age 8
BRT model
```{r}
bc8_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 8),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(bc8_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc8_brt)
```
Relative influence plot
```{r}
ggInfluence(bc8_brt)
```
Interactive effects among predictors
```{r}
bc8.interactions <- gbm.interactions(bc8_brt)
bc8.interactions$interactions
bc8.interactions$rank.list

```

######Age 9
BRT model
```{r}
bc9_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 9),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(bc9_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc9_brt)
```
Relative influence plot
```{r}
ggInfluence(bc9_brt)
```
Interactive effects among predictors
```{r}
bc9.interactions <- gbm.interactions(bc9_brt)
bc9.interactions$interactions
bc9.interactions$rank.list

```

######Age 10
BRT model
```{r}
bc10_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 10),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(bc10_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc10_brt)
```
Relative influence plot
```{r}
ggInfluence(bc10_brt)
```
Interactive effects among predictors
```{r}
bc10.interactions <- gbm.interactions(bc10_brt)
bc10.interactions$interactions
bc10.interactions$rank.list

```
######Age 11
BRT model
```{r}
bc11_brt <-
  gbm.step(
    data = bc.grow %>% filter(age_group == 11),
    # data frame with rows of observations and columns of values
    gbm.x = bc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(bc11_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(bc11_brt)
```
Relative influence plot
```{r}
ggInfluence(bc11_brt)
```
Interactive effects among predictors
```{r}
bc11.interactions <- gbm.interactions(bc11_brt)
bc11.interactions$interactions
bc11.interactions$rank.list

```



###Combined Plots

######Format fitted functions
```{r}
bc.response.matrix <- bind_rows(
  #age group 0
  bind_rows(
  gbm::plot.gbm(bc0_brt,i.var = "dd_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = dd_year) %>% 
    mutate(Predictor_Name = "dd_year",
           y = scale(y)),
  gbm::plot.gbm(bc0_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc0_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc0_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc0_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc0_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc0_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc0_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc0_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc0_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 0),
  #age group 1
  bind_rows(
  gbm::plot.gbm(bc1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(bc2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(bc3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(bc4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 5
  gbm::plot.gbm(bc5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(bc6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(bc7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 7),
  bind_rows(
    #age group 8
  gbm::plot.gbm(bc8_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc8_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc8_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc8_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc8_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc8_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc8_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc8_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc8_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc8_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 8),
  bind_rows(
    #age group 9
  gbm::plot.gbm(bc9_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc9_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc9_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc9_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc9_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc9_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc9_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc9_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc9_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc9_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 9),
  bind_rows(
    #age group 10
  gbm::plot.gbm(bc10_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc10_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc10_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc10_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc10_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc10_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc10_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc10_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc10_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc10_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 10),
   bind_rows(
    #age group 11
  gbm::plot.gbm(bc11_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(bc11_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(bc11_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(bc11_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(bc11_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(bc11_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(bc11_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(bc11_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(bc11_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(bc11_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 11)
) %>% mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name == "begin_date_year" ~ "Year",
               Predictor_Name %in% c("DD_mean", "dd_year") ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
bc.rel.inf <- bind_rows(
  bc1_brt$contributions %>% mutate(Age_Group = 0),
  bc1_brt$contributions %>% mutate(Age_Group = 1),
  bc2_brt$contributions %>% mutate(Age_Group = 2),
  bc3_brt$contributions %>% mutate(Age_Group = 3),
  bc4_brt$contributions %>% mutate(Age_Group = 4),
  bc5_brt$contributions %>% mutate(Age_Group = 5),
  bc6_brt$contributions %>% mutate(Age_Group = 6),
  bc7_brt$contributions %>% mutate(Age_Group = 7),
  bc8_brt$contributions %>% mutate(Age_Group = 8),
  bc9_brt$contributions %>% mutate(Age_Group = 9),
  bc10_brt$contributions %>% mutate(Age_Group = 10),
  bc11_brt$contributions %>% mutate(Age_Group = 11)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var %in% c("DD_mean", "dd_year") ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c( "Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.bc.rel.inf <- bc.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

bc.response.matrix.rel.inf <- bc.response.matrix %>% 
  left_join(mean.bc.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(bc.partial.plot <- ggplot(bc.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
  labs(y = "Fitted Function", x = "Predictor Values")+
  scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/bc_partial_dependency.tiff",
       bc.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(bc.rel.inf.plot <- ggplot(bc.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
  
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/bc_rel_inf.tiff",
       bc.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```




##Green Sunfish

Filter for Green Sunfish (Lepomis cyanellus)
```{r}
lepcya.grow <- all.grow.merge %>% 
  filter(species == "green_sunfish", !is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(lakename = as.factor(lakename), #change each of these variables from class character to factor
         county = as.factor(county),
         begin_date_month = as.factor(begin_date_month))

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(lepcya.grow) #inspect column names
lepcya.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39) #create vector with desired predictors
```

######Age 0
BRT model
```{r}
#n = 1
# lepcya0_brt <- gbm.step(data=lepcya.grow %>% filter(age_group == 0), # data frame with rows of observations and columns of values
#                      gbm.x = c(lepcya.grow.preds[-c(14)], 33), #DD_mean for age 0 is NA, use dd_year instead for age 0
#                      gbm.y = 6, # column number with response variable
#                      family = "gaussian", # distribution of response variable
#                      tree.complexity = 5, # range 0-5, 0 being the least complex and runs fastest
#                      learning.rate = 0.1, # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
#                      bag.fraction = 0.5,  # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#                      n.folds = 10,
#                      n.trees = 50,
#                      step.size = 1000,
#                      max.trees = 1000000,
#                      tolerance = 0.001
# 
#                      )

```
######Age 1
BRT model
```{r}
#n = 14
# lepcya1_brt <-
#   gbm.step(
#     data = lepcya.grow %>% filter(age_group == 1),
#     # data frame with rows of observations and columns of values
#     gbm.x = lepcya.grow.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.1,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 1000,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )
```

######Age 2
BRT model
```{r}
# n = 31
# lepcya2_brt <- gbm.step(
#   data = lepcya.grow %>% filter(age_group == 2),
#   # data frame with rows of observations and columns of values
#   gbm.x = lepcya.grow.preds,
#   # vector of column numbers of explanatory variables
#   gbm.y = 6,
#   # column number with response variable
#   family = "gaussian",
#   # distribution of response variable
#   tree.complexity = 5,
#   # range 0-5, 0 being the least complex and runs fastest
#   learning.rate = 0.1,
#   # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
#   bag.fraction = 0.5,
#   # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#   n.folds = 10,
#   n.trees = 50,
#   step.size = 1000,
#   max.trees = 1000000,
#   tolerance = 0.001
#   
# )

```

######Age 3
BRT model
```{r}
lepcya3_brt <-
  gbm.step(
    data = lepcya.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = lepcya.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 10,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(lepcya3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepcya3_brt)
```
Relative influence plot
```{r}
ggInfluence(lepcya3_brt)
```
Interactive effects among predictors
```{r}
lepcya3.interactions <- gbm.interactions(lepcya3_brt)
lepcya3.interactions$interactions
lepcya3.interactions$rank.list

```

######Age 4
BRT model
```{r}
#n = 45
# lepcya4_brt <-
#   gbm.step(
#     data = lepcya.grow %>% filter(age_group == 4),
#     # data frame with rows of observations and columns of values
#     gbm.x = lepcya.grow.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.1,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```


###Bluegill

Filter for Bluegill (Lepomis macrochirus) 
```{r}
lepmac.grow <- all.grow.merge %>%
  filter(species == "bluegill",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(lepmac.grow) #inspect column names
lepmac.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
lepmac0_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 0),
    # data frame with rows of observations and columns of values
    gbm.x = age0.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 0.5,
    max.trees = 1000000,
    tolerance = 0.001

  )

```

Partial dependency plot
```{r}
gbm.plot(lepmac0_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac0_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac0_brt)
```
Interactive effects among predictors
```{r}
lepmac0.interactions <- gbm.interactions(lepmac0_brt)
lepmac0.interactions$interactions
lepmac0.interactions$rank.list

```

######Age 1
BRT model
```{r}
lepmac1_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(lepmac1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac1_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac1_brt)
```
Interactive effects among predictors
```{r}
lepmac1.interactions <- gbm.interactions(lepmac1_brt)
lepmac1.interactions$interactions
lepmac1.interactions$rank.list

```

######Age 2
BRT model
```{r}
lepmac2_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(lepmac2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac2_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac2_brt)
```
Interactive effects among predictors
```{r}
lepmac2.interactions <- gbm.interactions(lepmac2_brt)
lepmac2.interactions$interactions
lepmac2.interactions$rank.list

```

######Age 3
BRT model
```{r}
lepmac3_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(lepmac3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac3_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac3_brt)
```
Interactive effects among predictors
```{r}
lepmac3.interactions <- gbm.interactions(lepmac3_brt)
lepmac3.interactions$interactions
lepmac3.interactions$rank.list

```

######Age 4
BRT model
```{r}
lepmac4_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(lepmac4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac4_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac4_brt)
```
Interactive effects among predictors
```{r}
lepmac4.interactions <- gbm.interactions(lepmac4_brt)
lepmac4.interactions$interactions
lepmac4.interactions$rank.list

```

######Age 5
BRT model
```{r}
lepmac5_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(lepmac5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac5_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac5_brt)
```
Interactive effects among predictors
```{r}
lepmac5.interactions <- gbm.interactions(lepmac5_brt)
lepmac5.interactions$interactions
lepmac5.interactions$rank.list

```

######Age 6
BRT model
```{r}
lepmac6_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 6),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(lepmac6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac6_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac6_brt)
```
Interactive effects among predictors
```{r}
lepmac6.interactions <- gbm.interactions(lepmac6_brt)
lepmac6.interactions$interactions
lepmac6.interactions$rank.list

```

######Age 7
BRT model
```{r}
lepmac7_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 7),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(lepmac7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac7_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac7_brt)
```
Interactive effects among predictors
```{r}
lepmac7.interactions <- gbm.interactions(lepmac7_brt)
lepmac7.interactions$interactions
lepmac7.interactions$rank.list

```

######Age 8
BRT model
```{r}
lepmac8_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 8),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(lepmac8_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac8_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac8_brt)
```
Interactive effects among predictors
```{r}
lepmac8.interactions <- gbm.interactions(lepmac8_brt)
lepmac8.interactions$interactions
lepmac8.interactions$rank.list

```

######Age 9
BRT model
```{r}
lepmac9_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 9),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(lepmac9_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac9_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac9_brt)
```
Interactive effects among predictors
```{r}
lepmac9.interactions <- gbm.interactions(lepmac9_brt)
lepmac9.interactions$interactions
lepmac9.interactions$rank.list

```

######Age 10
BRT model
```{r}
lepmac10_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 10),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 10,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(lepmac10_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac10_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac10_brt)
```
Interactive effects among predictors
```{r}
lepmac10.interactions <- gbm.interactions(lepmac10_brt)
lepmac10.interactions$interactions
lepmac10.interactions$rank.list

```

######Age 11
BRT model
```{r}
lepmac11_brt <-
  gbm.step(
    data = lepmac.grow %>% filter(age_group == 11),
    # data frame with rows of observations and columns of values
    gbm.x = lepmac.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 0.5,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(lepmac11_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(lepmac11_brt)
```
Relative influence plot
```{r}
ggInfluence(lepmac11_brt)
```
Interactive effects among predictors
```{r}
lepmac11.interactions <- gbm.interactions(lepmac11_brt)
lepmac11.interactions$interactions
lepmac11.interactions$rank.list

```


###Combined Plots

######Format fitted functions
```{r}
lepmac.response.matrix <- bind_rows(
  #age group 0
  bind_rows(
  gbm::plot.gbm(lepmac0_brt,i.var = "dd_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = dd_year) %>% 
    mutate(Predictor_Name = "dd_year",
           y = scale(y)),
  gbm::plot.gbm(lepmac0_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac0_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac0_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac0_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac0_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac0_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac0_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac0_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac0_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 0),
  #age group 1
  bind_rows(
  gbm::plot.gbm(lepmac1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(lepmac2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(lepmac3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(lepmac4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 5
  gbm::plot.gbm(lepmac5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(lepmac6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(lepmac7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 7),
  bind_rows(
    #age group 8
  gbm::plot.gbm(lepmac8_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac8_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac8_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac8_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac8_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac8_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac8_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac8_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac8_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac8_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 8),
  bind_rows(
    #age group 9
  gbm::plot.gbm(lepmac9_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac9_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac9_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac9_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac9_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac9_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac9_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac9_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac9_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac9_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 9),
  bind_rows(
    #age group 10
  gbm::plot.gbm(lepmac10_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac10_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac10_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac10_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac10_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac10_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac10_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac10_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac10_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac10_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 10),
  bind_rows(
    #age group 11
  gbm::plot.gbm(lepmac11_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(lepmac11_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(lepmac11_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(lepmac11_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(lepmac11_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(lepmac11_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(lepmac11_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(lepmac11_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(lepmac11_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(lepmac11_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 11)
) %>% mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name  %in% c("DD_mean", "dd_year") ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
lepmac.rel.inf <- bind_rows(
  lepmac1_brt$contributions %>% mutate(Age_Group = 0),
  lepmac1_brt$contributions %>% mutate(Age_Group = 1),
  lepmac2_brt$contributions %>% mutate(Age_Group = 2),
  lepmac3_brt$contributions %>% mutate(Age_Group = 3),
  lepmac4_brt$contributions %>% mutate(Age_Group = 4),
  lepmac5_brt$contributions %>% mutate(Age_Group = 5),
  lepmac6_brt$contributions %>% mutate(Age_Group = 6),
  lepmac7_brt$contributions %>% mutate(Age_Group = 7),
  lepmac8_brt$contributions %>% mutate(Age_Group = 8),
  lepmac9_brt$contributions %>% mutate(Age_Group = 9),
  lepmac10_brt$contributions %>% mutate(Age_Group = 10),
  lepmac11_brt$contributions %>% mutate(Age_Group = 11)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var %in% c("DD_mean", "dd_year") ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.lepmac.rel.inf <- lepmac.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

lepmac.response.matrix.rel.inf <- lepmac.response.matrix %>% 
  left_join(mean.lepmac.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(lepmac.partial.plot <- ggplot(lepmac.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  geom_rug(sides = "b", linewidth = 0.01)+
  facet_wrap(~Predictor_Name, scales = "free")+
  labs(y = "Fitted Function", x = "Predictor Values")+
  scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/lepmac_partial_dependency.tiff",
       lepmac.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(lepmac.rel.inf.plot <- ggplot(lepmac.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
  
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/lepmac_rel_inf.tiff",
       lepmac.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```





###Smallmouth Bass

Filter for Smallmouth Bass (Micropterus dolomieu) 
```{r}
micdol.grow <- all.grow.merge %>%
  filter(species == "smallmouth_bass",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(micdol.grow) #inspect column names
micdol.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
micdol0_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 0),
    # data frame with rows of observations and columns of values
    gbm.x = age0.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.0001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 0.5,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micdol0_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol0_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol0_brt)
```
Interactive effects among predictors
```{r}
micdol0.interactions <- gbm.interactions(micdol0_brt)
micdol0.interactions$interactions
micdol0.interactions$rank.list

```

######Age 1
BRT model
```{r}
micdol1_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micdol1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol1_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol1_brt)
```
Interactive effects among predictors
```{r}
micdol1.interactions <- gbm.interactions(micdol1_brt)
micdol1.interactions$interactions
micdol1.interactions$rank.list

```

######Age 2
BRT model
```{r}
micdol2_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micdol2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol2_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol2_brt)
```
Interactive effects among predictors
```{r}
micdol2.interactions <- gbm.interactions(micdol2_brt)
micdol2.interactions$interactions
micdol2.interactions$rank.list

```

######Age 3
BRT model
```{r}
micdol3_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micdol3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol3_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol3_brt)
```
Interactive effects among predictors
```{r}
micdol3.interactions <- gbm.interactions(micdol3_brt)
micdol3.interactions$interactions
micdol3.interactions$rank.list

```

######Age 4
BRT model
```{r}
micdol4_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micdol4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol4_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol4_brt)
```
Interactive effects among predictors
```{r}
micdol4.interactions <- gbm.interactions(micdol4_brt)
micdol4.interactions$interactions
micdol4.interactions$rank.list

```

######Age 5
BRT model
```{r}
micdol5_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micdol5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol5_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol5_brt)
```
Interactive effects among predictors
```{r}
micdol5.interactions <- gbm.interactions(micdol5_brt)
micdol5.interactions$interactions
micdol5.interactions$rank.list

```

######Age 6
BRT model
```{r}
micdol6_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 6),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.75,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micdol6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol6_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol6_brt)
```
Interactive effects among predictors
```{r}
micdol6.interactions <- gbm.interactions(micdol6_brt)
micdol6.interactions$interactions
micdol6.interactions$rank.list

```

######Age 7
BRT model
```{r}
micdol7_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 7),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micdol7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol7_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol7_brt)
```
Interactive effects among predictors
```{r}
micdol7.interactions <- gbm.interactions(micdol7_brt)
micdol7.interactions$interactions
micdol7.interactions$rank.list

```

######Age 8
BRT model
```{r}
micdol8_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 8),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 100,
    n.trees = 500,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micdol8_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol8_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol8_brt)
```
Interactive effects among predictors
```{r}
micdol8.interactions <- gbm.interactions(micdol8_brt)
micdol8.interactions$interactions
micdol8.interactions$rank.list

```

######Age 9
BRT model
```{r}
micdol9_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 9),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micdol9_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol9_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol9_brt)
```
Interactive effects among predictors
```{r}
micdol9.interactions <- gbm.interactions(micdol9_brt)
micdol9.interactions$interactions
micdol9.interactions$rank.list

```

######Age 10
BRT model
```{r}
micdol10_brt <-
  gbm.step(
    data = micdol.grow %>% filter(age_group == 10),
    # data frame with rows of observations and columns of values
    gbm.x = micdol.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micdol10_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micdol10_brt)
```
Relative influence plot
```{r}
ggInfluence(micdol10_brt)
```
Interactive effects among predictors
```{r}
micdol10.interactions <- gbm.interactions(micdol10_brt)
micdol10.interactions$interactions
micdol10.interactions$rank.list

```

###Combined Plots

######Format fitted functions
```{r}
micdol.response.matrix <- bind_rows(
  #age group 0
  bind_rows(
  gbm::plot.gbm(micdol0_brt,i.var = "dd_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = dd_year) %>% 
    mutate(Predictor_Name = "dd_year",
           y = scale(y)),
  gbm::plot.gbm(micdol0_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol0_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol0_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol0_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol0_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol0_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol0_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol0_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol0_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 0),
  #age group 1
  bind_rows(
  gbm::plot.gbm(micdol1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(micdol2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(micdol3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(micdol4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 5
  gbm::plot.gbm(micdol5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(micdol6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(micdol7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 7),
  bind_rows(
    #age group 8
  gbm::plot.gbm(micdol8_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol8_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol8_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol8_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol8_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol8_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol8_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol8_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol8_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol8_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 8),
  bind_rows(
    #age group 9
  gbm::plot.gbm(micdol9_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol9_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol9_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol9_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol9_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol9_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol9_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol9_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol9_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol9_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 9),
  bind_rows(
    #age group 10
  gbm::plot.gbm(micdol10_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micdol10_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micdol10_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micdol10_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micdol10_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micdol10_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micdol10_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micdol10_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micdol10_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micdol10_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 10)
) %>% mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name %in% c("DD_mean", "dd_year") ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
micdol.rel.inf <- bind_rows(
  micdol1_brt$contributions %>% mutate(Age_Group = 0),
  micdol1_brt$contributions %>% mutate(Age_Group = 1),
  micdol2_brt$contributions %>% mutate(Age_Group = 2),
  micdol3_brt$contributions %>% mutate(Age_Group = 3),
  micdol4_brt$contributions %>% mutate(Age_Group = 4),
  micdol5_brt$contributions %>% mutate(Age_Group = 5),
  micdol6_brt$contributions %>% mutate(Age_Group = 6),
  micdol7_brt$contributions %>% mutate(Age_Group = 7),
  micdol8_brt$contributions %>% mutate(Age_Group = 8),
  micdol9_brt$contributions %>% mutate(Age_Group = 9),
  micdol9_brt$contributions %>% mutate(Age_Group = 10)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var %in% c("DD_mean", "dd_year") ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c( "Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.micdol.rel.inf <- micdol.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

micdol.response.matrix.rel.inf <- micdol.response.matrix %>% 
  left_join(mean.micdol.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(micdol.partial.plot <- ggplot(micdol.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
  labs(y = "Fitted Function", x = "Predictor Values")+
  scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/micdol_partial_dependency.tiff",
       micdol.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(micdol.rel.inf.plot <- ggplot(micdol.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
  
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/micdol_rel_inf.tiff",
       micdol.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```





###Largemouth Bass

Filter for Largemouth Bass (Micropterus salmoides) 
```{r}
micsal.grow <- all.grow.merge %>%
  filter(species == "largemouth_bass",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(micsal.grow) #inspect column names
micsal.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
micsal0_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 0),
    # data frame with rows of observations and columns of values
    gbm.x = age0.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micsal0_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal0_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal0_brt)
```
Interactive effects among predictors
```{r}
micsal0.interactions <- gbm.interactions(micsal0_brt)
micsal0.interactions$interactions
micsal0.interactions$rank.list

```

######Age 1
BRT model
```{r}
micsal1_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micsal1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal1_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal1_brt)
```
Interactive effects among predictors
```{r}
micsal1.interactions <- gbm.interactions(micsal1_brt)
micsal1.interactions$interactions
micsal1.interactions$rank.list

```

######Age 2
BRT model
```{r}
micsal2_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micsal2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal2_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal2_brt)
```
Interactive effects among predictors
```{r}
micsal2.interactions <- gbm.interactions(micsal2_brt)
micsal2.interactions$interactions
micsal2.interactions$rank.list

```

######Age 3
BRT model
```{r}
micsal3_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micsal3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal3_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal3_brt)
```
Interactive effects among predictors
```{r}
micsal3.interactions <- gbm.interactions(micsal3_brt)
micsal3.interactions$interactions
micsal3.interactions$rank.list

```

######Age 4
BRT model
```{r}
micsal4_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(micsal4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal4_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal4_brt)
```
Interactive effects among predictors
```{r}
micsal4.interactions <- gbm.interactions(micsal4_brt)
micsal4.interactions$interactions
micsal4.interactions$rank.list

```

######Age 5
BRT model
```{r}
micsal5_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micsal5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal5_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal5_brt)
```
Interactive effects among predictors
```{r}
micsal5.interactions <- gbm.interactions(micsal5_brt)
micsal5.interactions$interactions
micsal5.interactions$rank.listv

```

######Age 6
BRT model
```{r}
micsal6_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 6),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micsal6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal6_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal6_brt)
```
Interactive effects among predictors
```{r}
micsal6.interactions <- gbm.interactions(micsal6_brt)
micsal6.interactions$interactions
micsal6.interactions$rank.list

```

######Age 7
BRT model
```{r}
micsal7_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 7),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micsal7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal7_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal7_brt)
```
Interactive effects among predictors
```{r}
micsal7.interactions <- gbm.interactions(micsal7_brt)
micsal7.interactions$interactions
micsal7.interactions$rank.list

```

######Age 8
BRT model
```{r}
micsal8_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 8),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micsal8_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal8_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal8_brt)
```
Interactive effects among predictors
```{r}
micsal8.interactions <- gbm.interactions(micsal8_brt)
micsal8.interactions$interactions
micsal8.interactions$rank.list

```

######Age 9
BRT model
```{r}
micsal9_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 9),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micsal9_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal9_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal9_brt)
```
Interactive effects among predictors
```{r}
micsal9.interactions <- gbm.interactions(micsal9_brt)
micsal9.interactions$interactions
micsal9.interactions$rank.list

```

######Age 10
BRT model
```{r}
micsal10_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 10),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micsal10_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal10_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal10_brt)
```
Interactive effects among predictors
```{r}
micsal10.interactions <- gbm.interactions(micsal10_brt)
micsal10.interactions$interactions
micsal10.interactions$rank.list

```

######Age 11
BRT model
```{r}
micsal11_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 11),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micsal11_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal11_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal11_brt)
```
Interactive effects among predictors
```{r}
micsal11.interactions <- gbm.interactions(micsal11_brt)
micsal11.interactions$interactions
micsal11.interactions$rank.list

```

######Age 12
BRT model
```{r}
micsal12_brt <-
  gbm.step(
    data = micsal.grow %>% filter(age_group == 12),
    # data frame with rows of observations and columns of values
    gbm.x = micsal.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(micsal12_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(micsal12_brt)
```
Relative influence plot
```{r}
ggInfluence(micsal12_brt)
```
Interactive effects among predictors
```{r}
micsal12.interactions <- gbm.interactions(micsal2_brt)
micsal12.interactions$interactions
micsal12.interactions$rank.list

```


###Combined Plots

######Format fitted functions
```{r}
micsal.response.matrix <- bind_rows(
  #age group 0
  bind_rows(
  gbm::plot.gbm(micsal0_brt,i.var = "dd_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = dd_year) %>% 
    mutate(Predictor_Name = "dd_year",
           y = scale(y)),
  gbm::plot.gbm(micsal0_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal0_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal0_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal0_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal0_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal0_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal0_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal0_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal0_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 0),
  #age group 1
  bind_rows(
  gbm::plot.gbm(micsal1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(micsal2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(micsal3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(micsal4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 5
  gbm::plot.gbm(micsal5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(micsal6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(micsal7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 7),
  bind_rows(
    #age group 8
  gbm::plot.gbm(micsal8_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal8_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal8_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal8_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal8_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal8_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal8_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal8_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal8_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal8_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 8),
  bind_rows(
    #age group 9
  gbm::plot.gbm(micsal9_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal9_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal9_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal9_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal9_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal9_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal9_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal9_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal9_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal9_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 9),
  bind_rows(
    #age group 10
  gbm::plot.gbm(micsal10_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal10_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal10_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal10_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal10_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal10_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal10_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal10_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal10_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal10_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 10),
  bind_rows(
    #age group 11
  gbm::plot.gbm(micsal11_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal11_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal11_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal11_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal11_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal11_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal11_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal11_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal11_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal11_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 11),
  bind_rows(
    #age group 12
  gbm::plot.gbm(micsal12_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(micsal12_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(micsal12_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(micsal12_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(micsal12_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(micsal12_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(micsal12_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(micsal12_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(micsal12_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(micsal12_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 12)
) %>% mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name %in% c("DD_mean", "dd_year") ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
micsal.rel.inf <- bind_rows(
  micsal1_brt$contributions %>% mutate(Age_Group = 0),
  micsal1_brt$contributions %>% mutate(Age_Group = 1),
  micsal2_brt$contributions %>% mutate(Age_Group = 2),
  micsal3_brt$contributions %>% mutate(Age_Group = 3),
  micsal4_brt$contributions %>% mutate(Age_Group = 4),
  micsal5_brt$contributions %>% mutate(Age_Group = 5),
  micsal6_brt$contributions %>% mutate(Age_Group = 6),
  micsal7_brt$contributions %>% mutate(Age_Group = 7),
  micsal8_brt$contributions %>% mutate(Age_Group = 8),
  micsal9_brt$contributions %>% mutate(Age_Group = 9),
  micsal9_brt$contributions %>% mutate(Age_Group = 10),
  micsal9_brt$contributions %>% mutate(Age_Group = 11),
  micsal9_brt$contributions %>% mutate(Age_Group = 12)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var %in% c("DD_mean", "dd_year") ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.micsal.rel.inf <- micsal.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

micsal.response.matrix.rel.inf <- micsal.response.matrix %>% 
  left_join(mean.micsal.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(micsal.partial.plot <- ggplot(micsal.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  labs(y = "Fitted Function", x = "Predictor Values")+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/micsal_partial_dependency.tiff",
       micsal.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(micsal.rel.inf.plot <- ggplot(micsal.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
  
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/micsal_rel_inf.tiff",
       micsal.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```





###Northern Pike

Filter for Northern Pike (Esox lucius) 
```{r}
esoluc.grow <- all.grow.merge %>%
  filter(species == "northern_pike",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(esoluc.grow) #inspect column names
esoluc.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
esoluc0_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 0),
    # data frame with rows of observations and columns of values
    gbm.x = age0.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(esoluc0_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc0_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc0_brt)
```
Interactive effects among predictors
```{r}
esoluc0.interactions <- gbm.interactions(esoluc0_brt)
esoluc0.interactions$interactions
esoluc0.interactions$rank.list

```

######Age 1
BRT model
```{r}
esoluc1_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(esoluc1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc1_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc1_brt)
```
Interactive effects among predictors
```{r}
esoluc1.interactions <- gbm.interactions(esoluc1_brt)
esoluc1.interactions$interactions
esoluc1.interactions$rank.list

```

######Age 2
BRT model
```{r}
esoluc2_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(esoluc2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc2_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc2_brt)
```
Interactive effects among predictors
```{r}
esoluc2.interactions <- gbm.interactions(esoluc2_brt)
esoluc2.interactions$interactions
esoluc2.interactions$rank.list

```

######Age 3
BRT model
```{r}
esoluc3_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(esoluc3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc3_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc3_brt)
```
Interactive effects among predictors
```{r}
esoluc3.interactions <- gbm.interactions(esoluc3_brt)
esoluc3.interactions$interactions
esoluc3.interactions$rank.list

```

######Age 4
BRT model
```{r}
esoluc4_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(esoluc4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc4_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc4_brt)
```
Interactive effects among predictors
```{r}
esoluc4.interactions <- gbm.interactions(esoluc4_brt)
esoluc4.interactions$interactions
esoluc4.interactions$rank.list

```

######Age 5
BRT model
```{r}
esoluc5_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(esoluc5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc5_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc5_brt)
```
Interactive effects among predictors
```{r}
esoluc5.interactions <- gbm.interactions(esoluc5_brt)
esoluc5.interactions$interactions
esoluc5.interactions$rank.list

```

######Age 6
BRT model
```{r}
esoluc6_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 6),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(esoluc6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc6_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc6_brt)
```
Interactive effects among predictors
```{r}
esoluc6.interactions <- gbm.interactions(esoluc6_brt)
esoluc6.interactions$interactions
esoluc6.interactions$rank.list

```

######Age 7
BRT model
```{r}
esoluc7_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 7),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.4,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(esoluc7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc7_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc7_brt)
```
Interactive effects among predictors
```{r}
esoluc7.interactions <- gbm.interactions(esoluc7_brt)
esoluc7.interactions$interactions
esoluc7.interactions$rank.list

```

######Age 8
BRT model
```{r}
esoluc8_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 8),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.4,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(esoluc8_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc8_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc8_brt)
```
Interactive effects among predictors
```{r}
esoluc8.interactions <- gbm.interactions(esoluc8_brt)
esoluc8.interactions$interactions
esoluc8.interactions$rank.list

```

######Age 9
BRT model
```{r}
esoluc9_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 9),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(esoluc9_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc9_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc9_brt)
```
Interactive effects among predictors
```{r}
esoluc9.interactions <- gbm.interactions(esoluc9_brt)
esoluc9.interactions$interactions
esoluc9.interactions$rank.list

```

######Age 10
BRT model
```{r}
esoluc10_brt <-
  gbm.step(
    data = esoluc.grow %>% filter(age_group == 10),
    # data frame with rows of observations and columns of values
    gbm.x = esoluc.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(esoluc10_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(esoluc10_brt)
```
Relative influence plot
```{r}
ggInfluence(esoluc10_brt)
```
Interactive effects among predictors
```{r}
esoluc10.interactions <- gbm.interactions(esoluc10_brt)
esoluc10.interactions$interactions
esoluc10.interactions$rank.list

```

###Combined Plots

######Format fitted functions
```{r}
esoluc.response.matrix <- bind_rows(  
  #age group 0
  bind_rows(
  gbm::plot.gbm(esoluc0_brt,i.var = "dd_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = dd_year) %>% 
    mutate(Predictor_Name = "dd_year",
           y = scale(y)),
  gbm::plot.gbm(esoluc0_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc0_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc0_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc0_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc0_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc0_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc0_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc0_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc0_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 0),
  #age group 1
  bind_rows(
  gbm::plot.gbm(esoluc1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(esoluc2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(esoluc3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(esoluc4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 5
  gbm::plot.gbm(esoluc5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(esoluc6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(esoluc7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 7),
  bind_rows(
    #age group 8
  gbm::plot.gbm(esoluc8_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc8_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc8_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc8_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc8_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc8_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc8_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc8_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc8_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc8_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 8),
  bind_rows(
    #age group 9
  gbm::plot.gbm(esoluc9_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc9_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc9_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc9_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc9_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc9_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc9_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc9_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc9_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc9_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 9),
  bind_rows(
    #age group 10
  gbm::plot.gbm(esoluc10_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(esoluc10_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(esoluc10_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(esoluc10_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(esoluc10_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(esoluc10_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(esoluc10_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(esoluc10_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(esoluc10_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(esoluc10_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 10)
) %>% mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name %in% c("DD_mean", "dd_year") ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
esoluc.rel.inf <- bind_rows(
  esoluc1_brt$contributions %>% mutate(Age_Group = 0),
  esoluc1_brt$contributions %>% mutate(Age_Group = 1),
  esoluc2_brt$contributions %>% mutate(Age_Group = 2),
  esoluc3_brt$contributions %>% mutate(Age_Group = 3),
  esoluc4_brt$contributions %>% mutate(Age_Group = 4),
  esoluc5_brt$contributions %>% mutate(Age_Group = 5),
  esoluc6_brt$contributions %>% mutate(Age_Group = 6),
  esoluc7_brt$contributions %>% mutate(Age_Group = 7),
  esoluc8_brt$contributions %>% mutate(Age_Group = 8),
  esoluc9_brt$contributions %>% mutate(Age_Group = 9),
  esoluc9_brt$contributions %>% mutate(Age_Group = 10)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var %in% c("DD_mean", "dd_year") ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.esoluc.rel.inf <- esoluc.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

esoluc.response.matrix.rel.inf <- esoluc.response.matrix %>% 
  left_join(mean.esoluc.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(esoluc.partial.plot <- ggplot(esoluc.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  labs(y = "Fitted Function", x = "Predictor Values")+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/esoluc_partial_dependency.tiff",
       esoluc.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(esoluc.rel.inf.plot <- ggplot(esoluc.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
  
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/esoluc_rel_inf.tiff",
       esoluc.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```





###Yellow Perch

Filter for Yellow Perch (Perca flavescens) 
```{r}
perfla.grow <- all.grow.merge %>%
  filter(species == "yellow_perch",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(perfla.grow) #inspect column names
perfla.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
perfla0_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 0),
    # data frame with rows of observations and columns of values
    gbm.x = age0.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(perfla0_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla0_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla0_brt)
```
Interactive effects among predictors
```{r}
perfla0.interactions <- gbm.interactions(perfla0_brt)
perfla0.interactions$interactions
perfla0.interactions$rank.list

```

######Age 1
BRT model
```{r}
perfla1_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(perfla1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla1_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla1_brt)
```
Interactive effects among predictors
```{r}
perfla1.interactions <- gbm.interactions(perfla1_brt)
perfla1.interactions$interactions
perfla1.interactions$rank.list

```

######Age 2
BRT model
```{r}
perfla2_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(perfla2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla2_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla2_brt)
```
Interactive effects among predictors
```{r}
perfla2.interactions <- gbm.interactions(perfla2_brt)
perfla2.interactions$interactions
perfla2.interactions$rank.list

```

######Age 3
BRT model
```{r}
perfla3_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.01,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(perfla3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla3_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla3_brt)
```
Interactive effects among predictors
```{r}
perfla3.interactions <- gbm.interactions(perfla3_brt)
perfla3.interactions$interactions
perfla3.interactions$rank.list

```

######Age 4
BRT model
```{r}
perfla4_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(perfla4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla4_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla4_brt)
```
Interactive effects among predictors
```{r}
perfla4.interactions <- gbm.interactions(perfla4_brt)
perfla4.interactions$interactions
perfla4.interactions$rank.list

```

######Age 5
BRT model
```{r}
perfla5_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(perfla5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla5_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla5_brt)
```
Interactive effects among predictors
```{r}
perfla5.interactions <- gbm.interactions(perfla5_brt)
perfla5.interactions$interactions
perfla5.interactions$rank.list

```

######Age 6
BRT model
```{r}
perfla6_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 6),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(perfla6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla6_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla6_brt)
```
Interactive effects among predictors
```{r}
perfla6.interactions <- gbm.interactions(perfla6_brt)
perfla6.interactions$interactions
perfla6.interactions$rank.list

```

######Age 7
BRT model
```{r}
perfla7_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 7),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(perfla7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla7_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla7_brt)
```
Interactive effects among predictors
```{r}
perfla7.interactions <- gbm.interactions(perfla7_brt)
perfla7.interactions$interactions
perfla7.interactions$rank.list

```

######Age 8
BRT model
```{r}
perfla8_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 8),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(perfla8_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla8_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla8_brt)
```
Interactive effects among predictors
```{r}
perfla8.interactions <- gbm.interactions(perfla8_brt)
perfla8.interactions$interactions
perfla8.interactions$rank.list

```

######Age 9
BRT model
```{r}
perfla9_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 9),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(perfla9_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla9_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla9_brt)
```
Interactive effects among predictors
```{r}
perfla9.interactions <- gbm.interactions(perfla9_brt)
perfla9.interactions$interactions
perfla9.interactions$rank.list

```

######Age 10
BRT model
```{r}
perfla10_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 10),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(perfla10_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla10_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla10_brt)
```
Interactive effects among predictors
```{r}
perfla10.interactions <- gbm.interactions(perfla10_brt)
perfla10.interactions$interactions
perfla10.interactions$rank.list

```

######Age 11
BRT model
```{r}
perfla11_brt <-
  gbm.step(
    data = perfla.grow %>% filter(age_group == 11),
    # data frame with rows of observations and columns of values
    gbm.x = perfla.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.001,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 0.1,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(perfla11_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(perfla11_brt)
```
Relative influence plot
```{r}
ggInfluence(perfla11_brt)
```
Interactive effects among predictors
```{r}
perfla11.interactions <- gbm.interactions(perfla11_brt)
perfla11.interactions$interactions
perfla11.interactions$rank.list

```



###Combined Plots

######Format fitted functions
```{r}
perfla.response.matrix <- bind_rows(
  #age group 0
  bind_rows(
  gbm::plot.gbm(perfla0_brt,i.var = "dd_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = dd_year) %>% 
    mutate(Predictor_Name = "dd_year",
           y = scale(y)),
  gbm::plot.gbm(perfla0_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla0_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla0_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla0_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla0_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla0_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla0_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla0_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla0_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 0),
  #age group 1
  bind_rows(
  gbm::plot.gbm(perfla1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(perfla2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(perfla3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(perfla4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 5
  gbm::plot.gbm(perfla5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(perfla6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(perfla7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 7),
  bind_rows(
    #age group 8
  gbm::plot.gbm(perfla8_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla8_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla8_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla8_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla8_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla8_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla8_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla8_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla8_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla8_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 8),
  bind_rows(
    #age group 9
  gbm::plot.gbm(perfla9_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla9_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla9_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla9_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla9_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla9_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla9_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla9_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla9_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla9_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 9),
  bind_rows(
    #age group 10
  gbm::plot.gbm(perfla10_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla10_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla10_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla10_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla10_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla10_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla10_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla10_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla10_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla10_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 10),
  bind_rows(
    #age group 11
  gbm::plot.gbm(perfla11_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(perfla11_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(perfla11_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(perfla11_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(perfla11_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(perfla11_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(perfla11_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(perfla11_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(perfla11_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(perfla11_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 11)
) %>% mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name %in% c("DD_mean", "dd_year") ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
perfla.rel.inf <- bind_rows(
  perfla1_brt$contributions %>% mutate(Age_Group = 0),
  perfla1_brt$contributions %>% mutate(Age_Group = 1),
  perfla2_brt$contributions %>% mutate(Age_Group = 2),
  perfla3_brt$contributions %>% mutate(Age_Group = 3),
  perfla4_brt$contributions %>% mutate(Age_Group = 4),
  perfla5_brt$contributions %>% mutate(Age_Group = 5),
  perfla6_brt$contributions %>% mutate(Age_Group = 6),
  perfla7_brt$contributions %>% mutate(Age_Group = 7),
  perfla8_brt$contributions %>% mutate(Age_Group = 8),
  perfla9_brt$contributions %>% mutate(Age_Group = 9),
  perfla10_brt$contributions %>% mutate(Age_Group = 10),
  perfla11_brt$contributions %>% mutate(Age_Group = 11)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var %in% c("DD_mean", "dd_year") ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.perfla.rel.inf <- perfla.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

perfla.response.matrix.rel.inf <- perfla.response.matrix %>% 
  left_join(mean.perfla.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(perfla.partial.plot <- ggplot(perfla.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  labs(y = "Fitted Function", x = "Predictor Values")+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/perfla_partial_dependency.tiff",
       perfla.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(perfla.rel.inf.plot <- ggplot(perfla.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
  
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/perfla_rel_inf.tiff",
       perfla.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```




###White Sucker

Filter for White Sucker (Catostomus commersonii) 
```{r}
catcom.grow <- all.grow.merge %>%
  filter(species == "common_white_sucker",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(catcom.grow) #inspect column names
catcom.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
# n = 2 
# catcom0_brt <-
#   gbm.step(
#     data = catcom.grow %>% filter(age_group == 0),
#     # data frame with rows of observations and columns of values
#     gbm.x = age0.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.001,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```

######Age 1
BRT model
```{r}
catcom1_brt <-
  gbm.step(
    data = catcom.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = catcom.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(catcom1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(catcom1_brt)
```
Relative influence plot
```{r}
ggInfluence(catcom1_brt)
```
Interactive effects among predictors
```{r}
catcom1.interactions <- gbm.interactions(catcom1_brt)
catcom1.interactions$interactions
catcom1.interactions$rank.list

```

######Age 2
BRT model
```{r}
catcom2_brt <-
  gbm.step(
    data = catcom.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = catcom.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(catcom2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(catcom2_brt)
```
Relative influence plot
```{r}
ggInfluence(catcom2_brt)
```
Interactive effects among predictors
```{r}
catcom2.interactions <- gbm.interactions(catcom2_brt)
catcom2.interactions$interactions
catcom2.interactions$rank.list

```

######Age 3
BRT model
```{r}
catcom3_brt <-
  gbm.step(
    data = catcom.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = catcom.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(catcom3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(catcom3_brt)
```
Relative influence plot
```{r}
ggInfluence(catcom3_brt)
```
Interactive effects among predictors
```{r}
catcom3.interactions <- gbm.interactions(catcom3_brt)
catcom3.interactions$interactions
catcom3.interactions$rank.list

```

######Age 4
BRT model
```{r}
catcom4_brt <-
  gbm.step(
    data = catcom.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = catcom.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(catcom4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(catcom4_brt)
```
Relative influence plot
```{r}
ggInfluence(catcom4_brt)
```
Interactive effects among predictors
```{r}
catcom4.interactions <- gbm.interactions(catcom4_brt)
catcom4.interactions$interactions
catcom4.interactions$rank.list

```

######Age 5
BRT model
```{r}
catcom5_brt <-
  gbm.step(
    data = catcom.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = catcom.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(catcom5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(catcom5_brt)
```
Relative influence plot
```{r}
ggInfluence(catcom5_brt)
```
Interactive effects among predictors
```{r}
catcom5.interactions <- gbm.interactions(catcom5_brt)
catcom5.interactions$interactions
catcom5.interactions$rank.list

```

######Age 6
BRT model
```{r}
# n = 43
# catcom6_brt <-
#   gbm.step(
#     data = catcom.grow %>% filter(age_group == 6),
#     # data frame with rows of observations and columns of values
#     gbm.x = catcom.grow.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.1,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```

######Format fitted functions
```{r}
catcom.response.matrix <- bind_rows(
  bind_rows(
    #age group 1
  gbm::plot.gbm(catcom1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(catcom1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(catcom1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(catcom1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(catcom1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(catcom1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(catcom1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(catcom1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(catcom1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(catcom1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(catcom2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(catcom2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(catcom2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(catcom2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(catcom2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(catcom2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(catcom2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(catcom2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(catcom2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(catcom2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(catcom3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(catcom3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(catcom3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(catcom3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(catcom3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(catcom3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(catcom3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(catcom3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(catcom3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(catcom3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(catcom4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(catcom4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(catcom4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(catcom4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(catcom4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(catcom4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(catcom4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(catcom4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(catcom4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(catcom4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 1
  gbm::plot.gbm(catcom5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(catcom5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(catcom5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(catcom5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(catcom5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(catcom5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(catcom5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(catcom5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(catcom5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(catcom5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5)) %>% 
    mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name == "DD_mean" ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
catcom.rel.inf <- bind_rows(
  catcom1_brt$contributions %>% mutate(Age_Group = 1),
  catcom2_brt$contributions %>% mutate(Age_Group = 2),
  catcom3_brt$contributions %>% mutate(Age_Group = 3),
  catcom4_brt$contributions %>% mutate(Age_Group = 4),
  catcom5_brt$contributions %>% mutate(Age_Group = 5)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var == "DD_mean" ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.catcom.rel.inf <- catcom.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

catcom.response.matrix.rel.inf <- catcom.response.matrix %>% 
  left_join(mean.catcom.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(catcom.partial.plot <- ggplot(catcom.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  labs(y = "Fitted Function", x = "Predictor Values")+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/catcom_partial_dependency.tiff",
       catcom.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(catcom.rel.inf.plot <- ggplot(catcom.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/catcom_rel_inf.tiff",
       catcom.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```



###Brown Trout

Filter for Brown Trout (Salmo trutta) 
```{r}
saltru.grow <- all.grow.merge %>%
  filter(species == "brown_trout",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(saltru.grow) #inspect column names
saltru.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
#n = 2
# saltru0_brt <-
#   gbm.step(
#     data = saltru.grow %>% filter(age_group == 0),
#     # data frame with rows of observations and columns of values
#     gbm.x = age0.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.001,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```

######Age 1
BRT model
```{r}
saltru1_brt <-
  gbm.step(
    data = saltru.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = saltru.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(saltru1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(saltru1_brt)
```
Relative influence plot
```{r}
ggInfluence(saltru1_brt)
```
Interactive effects among predictors
```{r}
saltru1.interactions <- gbm.interactions(saltru1_brt)
saltru1.interactions$interactions
saltru1.interactions$rank.list

```

######Age 2
BRT model
```{r}
saltru2_brt <-
  gbm.step(
    data = saltru.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = saltru.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(saltru2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(saltru2_brt)
```
Relative influence plot
```{r}
ggInfluence(saltru2_brt)
```
Interactive effects among predictors
```{r}
saltru2.interactions <- gbm.interactions(saltru2_brt)
saltru2.interactions$interactions
saltru2.interactions$rank.list

```

######Age 3
BRT model
```{r}
saltru3_brt <-
  gbm.step(
    data = saltru.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = saltru.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(saltru3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(saltru3_brt)
```
Relative influence plot
```{r}
ggInfluence(saltru3_brt)
```
Interactive effects among predictors
```{r}
saltru3.interactions <- gbm.interactions(saltru3_brt)
saltru3.interactions$interactions
saltru3.interactions$rank.list

```

######Age 4
BRT model
```{r}
saltru4_brt <-
  gbm.step(
    data = saltru.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = saltru.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(saltru4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(saltru4_brt)
```
Relative influence plot
```{r}
ggInfluence(saltru4_brt)
```
Interactive effects among predictors
```{r}
saltru4.interactions <- gbm.interactions(saltru4_brt)
saltru4.interactions$interactions
saltru4.interactions$rank.list

```

######Age 5
BRT model
```{r}
saltru5_brt <-
  gbm.step(
    data = saltru.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = saltru.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(saltru5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(saltru5_brt)
```
Relative influence plot
```{r}
ggInfluence(saltru5_brt)
```
Interactive effects among predictors
```{r}
saltru5.interactions <- gbm.interactions(saltru5_brt)
saltru5.interactions$interactions
saltru5.interactions$rank.list

```

######Age 6
BRT model
```{r}
#n = 20
# saltru6_brt <-
#   gbm.step(
#     data = saltru.grow %>% filter(age_group == 6),
#     # data frame with rows of observations and columns of values
#     gbm.x = saltru.grow.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.1,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```

######Format fitted functions
```{r}
saltru.response.matrix <- bind_rows(
  bind_rows(
    #age group 1
  gbm::plot.gbm(saltru1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(saltru1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(saltru1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(saltru1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(saltru1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(saltru1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(saltru1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(saltru1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(saltru1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(saltru1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(saltru2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(saltru2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(saltru2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(saltru2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(saltru2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(saltru2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(saltru2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(saltru2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(saltru2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(saltru2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(saltru3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(saltru3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(saltru3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(saltru3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(saltru3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(saltru3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(saltru3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(saltru3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(saltru3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(saltru3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(saltru4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(saltru4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(saltru4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(saltru4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(saltru4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(saltru4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(saltru4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(saltru4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(saltru4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(saltru4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 1
  gbm::plot.gbm(saltru5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(saltru5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(saltru5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(saltru5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(saltru5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(saltru5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(saltru5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(saltru5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(saltru5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(saltru5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5)) %>% 
    mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name == "DD_mean" ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
saltru.rel.inf <- bind_rows(
  saltru1_brt$contributions %>% mutate(Age_Group = 1),
  saltru2_brt$contributions %>% mutate(Age_Group = 2),
  saltru3_brt$contributions %>% mutate(Age_Group = 3),
  saltru4_brt$contributions %>% mutate(Age_Group = 4),
  saltru5_brt$contributions %>% mutate(Age_Group = 5)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var == "DD_mean" ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.saltru.rel.inf <- saltru.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

saltru.response.matrix.rel.inf <- saltru.response.matrix %>% 
  left_join(mean.saltru.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(saltru.partial.plot <- ggplot(saltru.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  labs(y = "Fitted Function", x = "Predictor Values")+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/saltru_partial_dependency.tiff",
       saltru.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(saltru.rel.inf.plot <- ggplot(saltru.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/saltru_rel_inf.tiff",
       saltru.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```




###Rainbow Trout

Filter for Rainbow Trout (Onchorhyncus mykiss) 
```{r}
oncmyk.grow <- all.grow.merge %>%
  filter(species == "rainbow_trout",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(oncmyk.grow) #inspect column names
oncmyk.grow.preds <- c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
#n = 2
# oncmyk0_brt <-
#   gbm.step(
#     data = oncmyk.grow %>% filter(age_group == 0),
#     # data frame with rows of observations and columns of values
#     gbm.x = age0.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.001,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```

######Age 1
BRT model
```{r}
oncmyk1_brt <-
  gbm.step(
    data = oncmyk.grow %>% filter(age_group == 1),
    # data frame with rows of observations and columns of values
    gbm.x = oncmyk.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(oncmyk1_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(oncmyk1_brt)
```
Relative influence plot
```{r}
ggInfluence(oncmyk1_brt)
```
Interactive effects among predictors
```{r}
oncmyk1.interactions <- gbm.interactions(oncmyk1_brt)
oncmyk1.interactions$interactions
oncmyk1.interactions$rank.list

```

######Age 2
BRT model
```{r}
oncmyk2_brt <-
  gbm.step(
    data = oncmyk.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = oncmyk.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(oncmyk2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(oncmyk2_brt)
```
Relative influence plot
```{r}
ggInfluence(oncmyk2_brt)
```
Interactive effects among predictors
```{r}
oncmyk2.interactions <- gbm.interactions(oncmyk2_brt)
oncmyk2.interactions$interactions
oncmyk2.interactions$rank.list

```

######Age 3
BRT model
```{r}
oncmyk3_brt <-
  gbm.step(
    data = oncmyk.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = oncmyk.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(oncmyk3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(oncmyk3_brt)
```
Relative influence plot
```{r}
ggInfluence(oncmyk3_brt)
```
Interactive effects among predictors
```{r}
oncmyk3.interactions <- gbm.interactions(oncmyk3_brt)
oncmyk3.interactions$interactions
oncmyk3.interactions$rank.list

```

######Age 4
BRT model
```{r}
oncmyk4_brt <-
  gbm.step(
    data = oncmyk.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = oncmyk.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.2,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(oncmyk4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(oncmyk4_brt)
```
Relative influence plot
```{r}
ggInfluence(oncmyk4_brt)
```
Interactive effects among predictors
```{r}
oncmyk4.interactions <- gbm.interactions(oncmyk4_brt)
oncmyk4.interactions$interactions
oncmyk4.interactions$rank.list

```

######Age 5
BRT model
```{r}
#n = 13
# oncmyk5_brt <-
#   gbm.step(
#     data = oncmyk.grow %>% filter(age_group == 5),
#     # data frame with rows of observations and columns of values
#     gbm.x = oncmyk.grow.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.1,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```

######Format fitted functions
```{r}
oncmyk.response.matrix <- bind_rows(
  bind_rows(
    #age group 1
  gbm::plot.gbm(oncmyk1_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(oncmyk1_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(oncmyk1_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(oncmyk1_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(oncmyk1_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(oncmyk1_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(oncmyk1_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(oncmyk1_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(oncmyk1_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(oncmyk1_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 1),
  #add age group 2
  bind_rows(
    gbm::plot.gbm(oncmyk2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(oncmyk2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(oncmyk2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(oncmyk2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(oncmyk2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(oncmyk2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(oncmyk2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(oncmyk2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(oncmyk2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(oncmyk2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(oncmyk3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(oncmyk3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(oncmyk3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(oncmyk3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(oncmyk3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(oncmyk3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(oncmyk3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(oncmyk3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(oncmyk3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(oncmyk3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(oncmyk4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(oncmyk4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(oncmyk4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(oncmyk4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(oncmyk4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(oncmyk4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(oncmyk4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(oncmyk4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(oncmyk4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(oncmyk4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4)
  ) %>% 
    mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name == "DD_mean" ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
oncmyk.rel.inf <- bind_rows(
  oncmyk1_brt$contributions %>% mutate(Age_Group = 1),
  oncmyk2_brt$contributions %>% mutate(Age_Group = 2),
  oncmyk3_brt$contributions %>% mutate(Age_Group = 3),
  oncmyk4_brt$contributions %>% mutate(Age_Group = 4)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var == "DD_mean" ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.oncmyk.rel.inf <- oncmyk.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

oncmyk.response.matrix.rel.inf <- oncmyk.response.matrix %>% 
  left_join(mean.oncmyk.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(oncmyk.partial.plot <- ggplot(oncmyk.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  labs(y = "Fitted Function", x = "Predictor Values")+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/oncmyk_partial_dependency.tiff",
       oncmyk.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(oncmyk.rel.inf.plot <- ggplot(oncmyk.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/oncmyk_rel_inf.tiff",
       oncmyk.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```



###Cisco

Filter for Cisco (Coregonus artedi) 
```{r}
corart.grow <- all.grow.merge %>%
  filter(species == "cisco",!is.na(length_mean_mm)) %>%  #remove rows w/ missing data for the response variable
  mutate(
    lakename = as.factor(lakename),
    #change each of these variables from class character to factor
    county = as.factor(county),
    begin_date_month = as.factor(begin_date_month)
  ) 

```

Create vector of column numbers of predictor variables that will be used in BRTs
```{r}
colnames(corart.grow) #inspect column names
corart.grow.preds <-  c(18, 20:23, 26, 33, 36, 37, 39)
```
######Age 0
BRT model
```{r}
#n = 4
# corart0_brt <-
#   gbm.step(
#     data = corart.grow %>% filter(age_group == 0),
#     # data frame with rows of observations and columns of values
#     gbm.x = age0.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.001,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```

######Age 1
BRT model
```{r}
#n = 32
# corart1_brt <-
#   gbm.step(
#     data = corart.grow %>% filter(age_group == 1),
#     # data frame with rows of observations and columns of values
#     gbm.x = corart.grow.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.1,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```

######Age 2
BRT model
```{r}
corart2_brt <-
  gbm.step(
    data = corart.grow %>% filter(age_group == 2),
    # data frame with rows of observations and columns of values
    gbm.x = corart.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(corart2_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(corart2_brt)
```
Relative influence plot
```{r}
ggInfluence(corart2_brt)
```
Interactive effects among predictors
```{r}
corart2.interactions <- gbm.interactions(corart2_brt)
corart2.interactions$interactions
corart2.interactions$rank.list

```

######Age 3
BRT model
```{r}
corart3_brt <-
  gbm.step(
    data = corart.grow %>% filter(age_group == 3),
    # data frame with rows of observations and columns of values
    gbm.x = corart.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.0 then go to 0.00 or 0.000 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(corart3_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(corart3_brt)
```
Relative influence plot
```{r}
ggInfluence(corart3_brt)
```
Interactive effects among predictors
```{r}
corart3.interactions <- gbm.interactions(corart3_brt)
corart3.interactions$interactions
corart3.interactions$rank.list

```

######Age 4
BRT model
```{r}
corart4_brt <-
  gbm.step(
    data = corart.grow %>% filter(age_group == 4),
    # data frame with rows of observations and columns of values
    gbm.x = corart.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```

Partial dependency plot
```{r}
gbm.plot(corart4_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(corart4_brt)
```
Relative influence plot
```{r}
ggInfluence(corart4_brt)
```
Interactive effects among predictors
```{r}
corart4.interactions <- gbm.interactions(corart4_brt)
corart4.interactions$interactions
corart4.interactions$rank.list

```

######Age 5
BRT model
```{r}
corart5_brt <-
  gbm.step(
    data = corart.grow %>% filter(age_group == 5),
    # data frame with rows of observations and columns of values
    gbm.x = corart.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.1,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.5,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(corart5_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(corart5_brt)
```
Relative influence plot
```{r}
ggInfluence(corart5_brt)
```
Interactive effects among predictors
```{r}
corart5.interactions <- gbm.interactions(corart5_brt)
corart5.interactions$interactions
corart5.interactions$rank.list

```

######Age 6
BRT model
```{r}
corart6_brt <-
  gbm.step(
    data = corart.grow %>% filter(age_group == 6),
    # data frame with rows of observations and columns of values
    gbm.x = corart.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.2,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.75,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(corart6_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(corart6_brt)
```
Relative influence plot
```{r}
ggInfluence(corart6_brt)
```
Interactive effects among predictors
```{r}
corart6.interactions <- gbm.interactions(corart6_brt)
corart6.interactions$interactions
corart6.interactions$rank.list

```

######Age 7
BRT model
```{r}
corart7_brt <-
  gbm.step(
    data = corart.grow %>% filter(age_group == 7),
    # data frame with rows of observations and columns of values
    gbm.x = corart.grow.preds,
    # vector of column numbers of explanatory variables
    gbm.y = 6,
    # column number with response variable
    family = "gaussian",
    # distribution of response variable
    tree.complexity = 5,
    # range 0-5, 0 being the least complex and runs fastest
    learning.rate = 0.2,
    # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
    bag.fraction = 0.75,
    # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
    n.folds = 10,
    n.trees = 50,
    step.size = 100,
    max.trees = 1000000,
    tolerance = 0.001
    
  )

```
Partial dependency plot
```{r}
gbm.plot(corart7_brt)
```
Model performance metrics
Per.expl is how well your explanatory variables explain the response (similar to R^2)
cvCorrelation is how well your training data predictions correlate with validation data 
```{r}
ggPerformance(corart7_brt)
```
Relative influence plot
```{r}
ggInfluence(corart7_brt)
```
Interactive effects among predictors
```{r}
corart7.interactions <- gbm.interactions(corart7_brt)
corart7.interactions$interactions
corart7.interactions$rank.list

```

######Age 8
BRT model
```{r}
# n = 38
# corart8_brt <-
#   gbm.step(
#     data = corart.grow %>% filter(age_group == 8),
#     # data frame with rows of observations and columns of values
#     gbm.x = corart.grow.preds,
#     # vector of column numbers of explanatory variables
#     gbm.y = 6,
#     # column number with response variable
#     family = "gaussian",
#     # distribution of response variable
#     tree.complexity = 5,
#     # range 0-5, 0 being the least complex and runs fastest
#     learning.rate = 0.1,
#     # size of steps between models, smaller steps mean more trees. I usually start with 0.1 then go to 0.01 or 0.001 depending on number of tree
#     bag.fraction = 0.5,
#     # percentage of data for training and for validation. 0.50 is good place to start, but with small datasets 0.75 is good.
#     n.folds = 10,
#     n.trees = 50,
#     step.size = 100,
#     max.trees = 1000000,
#     tolerance = 0.001
#     
#   )

```

###Combined Plots

######Format fitted functions
```{r}
corart.response.matrix <- bind_rows(
  #add age group 2
  bind_rows(
    gbm::plot.gbm(corart2_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(corart2_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(corart2_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(corart2_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(corart2_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(corart2_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(corart2_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(corart2_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(corart2_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(corart2_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 2),
  bind_rows(
    #age group 3
  gbm::plot.gbm(corart3_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(corart3_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(corart3_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(corart3_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(corart3_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(corart3_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(corart3_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(corart3_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(corart3_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(corart3_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 3),
  bind_rows(
    #age group 4
  gbm::plot.gbm(corart4_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(corart4_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(corart4_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(corart4_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(corart4_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(corart4_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(corart4_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(corart4_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(corart4_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(corart4_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 4),
  bind_rows(
    #age group 5
  gbm::plot.gbm(corart5_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(corart5_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(corart5_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(corart5_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(corart5_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(corart5_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(corart5_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(corart5_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(corart5_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(corart5_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 5),
  bind_rows(
    #age group 6
  gbm::plot.gbm(corart6_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(corart6_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(corart6_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(corart6_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(corart6_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(corart6_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(corart6_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(corart6_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(corart6_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(corart6_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 6),
  bind_rows(
    #age group 7
  gbm::plot.gbm(corart7_brt,i.var = "DD_mean", return.grid = TRUE) %>% 
    rename(Predictor_Value = DD_mean) %>% 
    mutate(Predictor_Name = "DD_mean",
           y = scale(y)),
  gbm::plot.gbm(corart7_brt,i.var = "mean_secchi_m", return.grid = TRUE) %>% 
    rename(Predictor_Value = mean_secchi_m) %>% 
    mutate(Predictor_Name = "mean_secchi_m",
           y = scale(y)),
  gbm::plot.gbm(corart7_brt,i.var = "urban", return.grid = TRUE) %>% 
    rename(Predictor_Value = urban) %>% 
    mutate(Predictor_Name = "urban",
           y = scale(y)),
  gbm::plot.gbm(corart7_brt,i.var = "agriculture", return.grid = TRUE) %>% 
    rename(Predictor_Value = agriculture) %>% 
    mutate(Predictor_Name = "agriculture",
           y = scale(y)),
  gbm::plot.gbm(corart7_brt,i.var = "forests", return.grid = TRUE) %>% 
    rename(Predictor_Value = forests) %>% 
    mutate(Predictor_Name = "forests",
           y = scale(y)),
  gbm::plot.gbm(corart7_brt,i.var = "wetlands", return.grid = TRUE) %>% 
    rename(Predictor_Value = wetlands) %>% 
    mutate(Predictor_Name = "wetlands",
           y = scale(y)),
  gbm::plot.gbm(corart7_brt,i.var = "doy", return.grid = TRUE) %>% 
    rename(Predictor_Value = doy) %>% 
    mutate(Predictor_Name = "doy",
           y = scale(y)),
  gbm::plot.gbm(corart7_brt,i.var = "log_max_depth", return.grid = TRUE) %>% 
    rename(Predictor_Value = log_max_depth) %>% 
    mutate(Predictor_Name = "log_max_depth",
           y = scale(y)),
  gbm::plot.gbm(corart7_brt,i.var = "logarea", return.grid = TRUE) %>% 
    rename(Predictor_Value = logarea) %>% 
    mutate(Predictor_Name = "logarea",
           y = scale(y)),
  gbm::plot.gbm(corart7_brt,i.var = "surf_temp_year", return.grid = TRUE) %>% 
    rename(Predictor_Value = surf_temp_year) %>% 
    mutate(Predictor_Name = "surf_temp_year",
           y = scale(y))
  ) %>% mutate(Age_Group = 7)
) %>% mutate(Age_Group = as.factor(Age_Group),
             Predictor_Name = case_when(
               Predictor_Name == "agriculture" ~ "Agriculture",
               Predictor_Name == "DD_mean" ~ "Degree Days",
               Predictor_Name == "doy" ~ "Day of Year",
               Predictor_Name == "forests" ~ "Forests",
               Predictor_Name == "logarea" ~ "Lake Area",
               Predictor_Name == "log_max_depth" ~ "Max Depth",
               Predictor_Name == "mean_secchi_m" ~ "Secchi Depth",
               Predictor_Name == "surf_temp_year" ~ "Surface Temperature",
               Predictor_Name == "urban" ~ "Urban",
               Predictor_Name == "wetlands" ~ "Wetlands",
               T ~ Predictor_Name
             ))
```

######Format relative influence
```{r}
corart.rel.inf <- bind_rows(
  corart2_brt$contributions %>% mutate(Age_Group = 2),
  corart3_brt$contributions %>% mutate(Age_Group = 3),
  corart4_brt$contributions %>% mutate(Age_Group = 4),
  corart5_brt$contributions %>% mutate(Age_Group = 5),
  corart6_brt$contributions %>% mutate(Age_Group = 6),
  corart7_brt$contributions %>% mutate(Age_Group = 7)
) %>% 
  mutate(Age_Group = as.factor(Age_Group)) %>% 
  mutate(Predictor_Name = case_when(
               var == "agriculture" ~ "Agriculture",
               var == "DD_mean" ~ "Degree Days",
               var == "doy" ~ "Day of Year",
               var == "forests" ~ "Forests",
               var == "logarea" ~ "Lake Area",
               var == "log_max_depth" ~ "Max Depth",
               var == "mean_secchi_m" ~ "Secchi Depth",
               var == "surf_temp_year" ~ "Surface Temperature",
               var == "urban" ~ "Urban",
               var == "wetlands" ~ "Wetlands"
             )) %>% 
  select(-var) %>% 
  mutate(`Variable Type` = case_when(
    Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
    Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
    Predictor_Name %in% c("Day of Year") ~ "Temporal",
    Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
    )
  )

mean.corart.rel.inf <- corart.rel.inf %>% 
  group_by(Predictor_Name) %>% 
  summarise(mean_rel_inf = mean(rel.inf)) 

corart.response.matrix.rel.inf <- corart.response.matrix %>% 
  left_join(mean.corart.rel.inf) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, desc(mean_rel_inf)))
```


######Plots
Partial dependency plot colored by age class
```{r}
(corart.partial.plot <- ggplot(corart.response.matrix.rel.inf, aes(x = Predictor_Value, y = y, color = Age_Group))+
  geom_line()+
  facet_wrap(~Predictor_Name, scales = "free")+
  labs(y = "Fitted Function", x = "Predictor Values")+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   scale_color_viridis_d()+
  theme_bw()
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/corart_partial_dependency.tiff",
       corart.partial.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Relative influence plot filled by age class
```{r}
(corart.rel.inf.plot <- ggplot(corart.rel.inf, aes(x = fct_reorder(Predictor_Name, rel.inf), 
                                                             y = rel.inf, fill = `Variable Type`))+
   geom_bar(stat = "identity")+
   geom_hline(yintercept = (1/10)*100)+
   facet_wrap(~Age_Group, scales = "free_x")+
   scale_fill_viridis_d(direction = -1)+
   labs(y = "Relative Influence", x = "Variable Name")+
   scale_y_continuous(expand = c(0,0))+
   coord_flip()+
   theme_bw()
   # theme(
   #   axis.text.x = element_text(angle = 45, hjust = 1)
   # )
  
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/corart_rel_inf.tiff",
       corart.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

#Multispecies plots
###Combine output
Combine response matrices for all species
```{r}
all.spp.response.matrix <- bind_rows(
  psf.response.matrix.rel.inf %>%
    mutate(
      Species = "Pumpkinseed Sunfish",
      `Thermal Guild` = "Warm",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7, 8, 9, 10) ~ "Adult"
      )
    ),
  wae.response.matrix.rel.inf %>%
    mutate(
      Species = "Walleye",
      `Thermal Guild` = "Cool",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7, 8, 9, 10, 11, 12) ~ "Adult"
      )
    ),
  rb.response.matrix.rel.inf %>%
    mutate(
      Species = "Rock Bass",
      `Thermal Guild` = "Cool",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7, 8, 9, 10, 11) ~ "Adult"
      )
    ),
  bc.response.matrix.rel.inf %>%
    mutate(
      Species = "Black Crappie",
      `Thermal Guild` = "Cool",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7, 8, 9, 10, 11) ~ "Adult"
      )
    ),
  lepmac.response.matrix.rel.inf %>%
    mutate(
      Species = "Bluegill",
      `Thermal Guild` = "Warm",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7, 8, 9, 10, 11) ~ "Adult"
      )
    ),
  micdol.response.matrix.rel.inf %>%
    mutate(
      Species = "Smallmouth Bass",
      `Thermal Guild` = "Warm",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7, 8, 9, 10) ~ "Adult"
      )
    ),
  micsal.response.matrix.rel.inf %>%
    mutate(
      Species = "Largemouth Bass",
      `Thermal Guild` = "Warm",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7, 8, 9, 10, 11, 12) ~ "Adult"
      )
    ),
  esoluc.response.matrix.rel.inf %>%
    mutate(
      Species = "Northern Pike",
      `Thermal Guild` = "Cool",
      `Trophic Guild` = "Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7, 8, 9, 10) ~ "Adult"
      )
    ),
  perfla.response.matrix.rel.inf %>%
    mutate(
      Species = "Yellow Perch",
      `Thermal Guild` = "Cool",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7, 8, 9, 10, 11) ~ "Adult"
      )
    ),
  catcom.response.matrix.rel.inf %>%
    mutate(
      Species = "White Sucker",
      `Thermal Guild` = "Cool",
      `Trophic Guild` = "Inv/Det",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5) ~ "Adult"
      )
    ),
  saltru.response.matrix.rel.inf %>%
    mutate(
      Species = "Brown Trout",
      `Thermal Guild` = "Cold",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5) ~ "Adult"
      )
    ),
  oncmyk.response.matrix.rel.inf %>%
    mutate(
      Species = "Rainbow Trout",
      `Thermal Guild` = "Cold",
      `Trophic Guild` = "Inv/Carn",
      Maturity = case_when(
        Age_Group %in% c (0, 1, 2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5) ~ "Adult"
      )
    ),
  corart.response.matrix.rel.inf %>%
    mutate(
      Species = "Cisco",
      `Thermal Guild` = "Cold",
      `Trophic Guild` = "Inv/Plank",
      Maturity = case_when(
        Age_Group %in% c (2, 3) ~ "Juvenile",
        Age_Group %in% c(4, 5, 6, 7) ~ "Adult"
      )
    )) %>%
    mutate(
      `Variable Type` = case_when(
        Predictor_Name %in% c("Agriculture", "Forests", "Urban", "Wetlands") ~ "Land Cover",
        Predictor_Name %in% c("Degree Days", "Surface Temperature") ~ "Climate",
        Predictor_Name %in% c("Day of Year") ~ "Temporal",
        Predictor_Name %in% c("Lake Area", "Max Depth", "Secchi Depth") ~ "Lake Attributes"
      ),
      #Set order of Maturity for linetype in plotting
      Maturity = fct_relevel(Maturity, "Juvenile", "Adult"),
      #Set order of Species to correspond to increasing final temperature preferendum for plotting
      Species = fct_relevel(Species, "Cisco", "Rainbow Trout", "Brown Trout", "Yellow Perch",
                                           "Northern Pike", "Walleye", "White Sucker", "Black Crappie", 
                                           "Rock Bass", "Smallmouth Bass", "Pumpkinseed Sunfish",
                                           "Largemouth Bass", "Bluegill"),
      Age_Group = as.factor(Age_Group),
      Age_Group = fct_relevel(Age_Group, "0", "1", "2", "3", "4", "5", "6", "7",
                              "8", "9", "10", "11", "12")
    )

```

###All spp degree days
```{r}
(all.spp.degree.days.plot <- ggplot(all.spp.response.matrix %>% 
                                     filter(Predictor_Name == "Degree Days",
                                            mean_rel_inf >= 10), 
                                aes(x = Predictor_Value, 
                                    y = y, 
                                    color = Age_Group))+
   geom_line(aes(linetype = Maturity))+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   facet_wrap(~Species, scales = "free_y")+
   labs(y = "Fitted Function", x = "Degree Days")+
   scale_color_viridis_d()+
   coord_cartesian(xlim = c(3000, 6000))+
   guides(color = guide_legend(title = "Age Class"))+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/all_spp_degree_days_partial_dependency.tiff",
       all.spp.degree.days.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")

```

######DD by trophic guild
Cold
```{r}
(degree.days.cold.plot <- ggplot(all.spp.response.matrix %>% 
                                     filter(Predictor_Name == "Degree Days", `Thermal Guild` == "Cold"), 
                                aes(x = Predictor_Value, 
                                    y = y, 
                                    color = `Thermal Guild`,
                                    #linetype = `Trophic Guild`,
                                    group = Species))+
   geom_line(linewidth = 0.5)+
   geom_rug(sides = "b", linewidth = 0.05)+
   facet_wrap(~Age_Group, scales = "free_y")+
   labs(y = "Fitted Function", x = "Degree Days")+
   scale_color_viridis_d()+
   coord_cartesian(xlim = c(3000, 6000))+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)

# ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/degree_days_cold_partial_dependency.tiff",
#        degree.days.cold.plot,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")

```

Cold
```{r}
(degree.days.cold.plot <- ggplot(all.spp.response.matrix %>% 
                                     filter(Predictor_Name == "Degree Days", `Thermal Guild` == "Cold"), 
                                aes(x = Predictor_Value, 
                                    y = y, 
                                    color = `Thermal Guild`,
                                    #linetype = `Trophic Guild`,
                                    group = Species))+
   geom_line(linewidth = 0.5)+
   geom_rug(sides = "b", linewidth = 0.05)+
   facet_wrap(~Age_Group, scales = "free_y")+
   labs(y = "Fitted Function", x = "Degree Days")+
   scale_color_viridis_d()+
   coord_cartesian(xlim = c(3000, 6000))+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)

# ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/degree_days_cold_partial_dependency.tiff",
#        degree.days.cold.plot,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")

```


Cool
```{r}
(degree.days.cool.plot <- ggplot(all.spp.response.matrix %>% 
                                     filter(Predictor_Name == "Degree Days", `Thermal Guild` == "Cool"), 
                                aes(x = Predictor_Value, 
                                    y = y, 
                                    color = `Thermal Guild`,
                                    #linetype = `Trophic Guild`,
                                    group = Species))+
   geom_line(linewidth = 0.5)+
   geom_rug(sides = "b", linewidth = 0.05)+
   facet_wrap(~Age_Group, scales = "free_y")+
   labs(y = "Fitted Function", x = "Degree Days")+
   scale_color_viridis_d(begin = 0.33)+
   coord_cartesian(xlim = c(3000, 6000))+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)

# ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/degree_days_cool_partial_dependency.tiff",
#        degree.days.cool.plot,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")

```

Warm
```{r}
(degree.days.warm.plot <- ggplot(all.spp.response.matrix %>% 
                                     filter(Predictor_Name == "Degree Days", `Thermal Guild` == "Warm"), 
                                aes(x = Predictor_Value, 
                                    y = y, 
                                    color = `Thermal Guild`,
                                    #linetype = `Trophic Guild`,
                                    group = Species))+
   geom_line(linewidth = 0.5)+
   facet_wrap(~Age_Group, scales = "free_y")+
   labs(y = "Fitted Function", x = "Degree Days")+
   scale_color_viridis_d(begin = 1)+
   coord_cartesian(xlim = c(3000, 6000))+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)

# ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/degree_days_warm_partial_dependency.tiff",
#        degree.days.warm.plot,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")

```

###All spp surface temp
```{r}
(all.spp.surface.temp.plot <- ggplot(all.spp.response.matrix %>% 
                                     filter(Predictor_Name == "Surface Temperature",
                                            mean_rel_inf >= 10), 
                                aes(x = Predictor_Value, 
                                    y = y, 
                                    color = Age_Group))+
   geom_line(aes(linetype = Maturity))+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   facet_wrap(~Species, scales = "free_y")+
   labs(y = "Fitted Function", x = "Surface Temperature")+
   guides(color = guide_legend(title = "Age Class"))+
   scale_color_viridis_d()+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)

ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/all_spp_surface_temperature_partial_dependency.tiff",
       all.spp.surface.temp.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

### Surf temp and DD partial dependency plots
```{r}
partial.dependency.surftemp.dd <- ggarrange(
  all.spp.surface.temp.plot,
  all.spp.degree.days.plot,
  ncol = 1,
  nrow = 2,
  labels = "AUTO",
  common.legend = T,
  legend = "right"
)

partial.dependency.surftemp.dd

ggsave("~/GitHub/EAGER_growth/Outputs/Figures/partial_dependency_surf_temp_dd.tiff",
       partial.dependency.surftemp.dd,
       dpi = 300,
       width = 200,
       height = 250,
       units = "mm")
```

### Graphical abstract plots
Create plot of largemouth bass surf temp and walleye dd for graphical abstract
```{r}
#organize data for plotting
lmb.wae <- all.spp.response.matrix %>% 
  filter((Species == "Largemouth Bass" & Predictor_Name == "Surface Temperature") | 
           (Species == "Walleye" & Predictor_Name == "Degree Days"))

(lmb.wae.plot <- ggplot(data = lmb.wae, aes(x = Predictor_Value, 
                                    y = y, 
                                    color = Age_Group))+
   geom_line(aes(linetype = Maturity), size = 2)+
   geom_rug(sides = "b", linewidth = 0.05, alpha = 0.5)+
   facet_wrap(~Species, scales = "free_x")+
   labs(y = "Fitted Function", x = NULL)+
   guides(color = guide_legend(title = "Age Class"))+
   scale_color_viridis_d()+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"),
         text = element_text(size = 30),
         strip.text = element_text(size = 36))
)

ggsave("~/GitHub/Disentangling_climate_effects_from_other_variables_on_fish_growth/Outputs/Figures/lmb_wae_plot.tiff",
       lmb.wae.plot,
       dpi = 300,
       width = 600,
       height = 300,
       units = "mm")

```
######Surface temp by thermal guild
Cold
```{r}
(surface.temp.cold.plot <- ggplot(all.spp.response.matrix %>% 
                                     filter(Predictor_Name == "Surface Temperature", `Thermal Guild` == "Cold"), 
                                aes(x = Predictor_Value, 
                                    y = y, 
                                    color = `Thermal Guild`,
                                    #linetype = `Trophic Guild`,
                                    group = Species))+
   geom_line(linewidth = 0.5)+
   facet_wrap(~Age_Group, scales = "free_y")+
   labs(y = "Fitted Function", x = "Surface Temperature")+
   scale_color_viridis_d()+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)

# ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/surface_temperature_cold_partial_dependency.tiff",
#        surface.temp.cold.plot,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")
```

Cool-Cold
```{r}
(surface.temp.cool.cold.plot <- ggplot(all.spp.response.matrix %>% 
                                     filter(Predictor_Name == "Surface Temperature", `Thermal Guild` == "Cool-Cold"), 
                                aes(x = Predictor_Value, 
                                    y = y, 
                                    color = `Thermal Guild`,
                                    #linetype = `Trophic Guild`,
                                    group = Species))+
   geom_line(linewidth = 0.5)+
   facet_wrap(~Age_Group, scales = "free_y")+
   labs(y = "Fitted Function", x = "Surface Temperature")+
   scale_color_viridis_d(begin = 0.67)+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)

# ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/surface_temperature_cool-cold_partial_dependency.tiff",
#        surface.temp.cool.cold.plot,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")
```

Cool
```{r}
(surface.temp.cool.plot <- ggplot(all.spp.response.matrix %>% 
                                     filter(Predictor_Name == "Surface Temperature", `Thermal Guild` == "Cool"), 
                                aes(x = Predictor_Value, 
                                    y = y, 
                                    color = `Thermal Guild`,
                                    #linetype = `Trophic Guild`,
                                    group = Species))+
   geom_line(linewidth = 0.5)+
   facet_wrap(~Age_Group, scales = "free_y")+
   labs(y = "Fitted Function", x = "Surface Temperature")+
   scale_color_viridis_d(begin = 0.33)+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)
# 
# ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/surface_temperature_cool_partial_dependency.tiff",
#        surface.temp.cool.plot,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")
```

Warm
```{r}
(surface.temp.warm.plot <- ggplot(all.spp.response.matrix %>%
                                     filter(Predictor_Name == "Surface Temperature", `Thermal Guild` == "Warm"),
                                aes(x = Predictor_Value,
                                    y = y,
                                    color = `Thermal Guild`,
                                    #linetype = `Trophic Guild`,
                                    group = Species))+
   geom_line(linewidth = 0.5)+
   facet_wrap(~Age_Group, scales = "free_y")+
   labs(y = "Fitted Function", x = "Surface Temperature")+
   scale_color_viridis_d(begin = 1)+
   theme_bw()+
   theme(legend.key = element_rect(fill = "grey"))
)

# ggsave(filename = "~/GitHub/EAGER_growth/Outputs/Figures/surface_temperature_warm_partial_dependency.tiff",
#        surface.temp.warm.plot,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")
```

###Synthesis Plots
General trends among species size classes in response to climate variables

####Proportions
Degree days percent of age classes increasing or decreasing w/ increasing DD
```{r}
#load results summary table 
brt.synthesis <- read.xlsx("~/GitHub/EAGER_growth/Data/brt_synthesis_table.xlsx") %>% 
  #rename some columns to be how I want them labeled in plots
  rename(`Degree Days` = Degree.Days, `Surface Temperature` = Surface.Temperature, 
         `Thermal Guild` = Thermal_Guild, `Trophic Guild` = Trophic_Guild)

#generate degree days plot
(dd.synthesis.plot <- ggplot(data = brt.synthesis %>% 
                               filter(dd_relinf == "Yes") %>% 
                             mutate(`Direction of Change` = `Degree Days`),
                             aes(x = `Thermal Guild`,
                                 fill = `Direction of Change`, Color = `Direction of Change`))+
    geom_bar(stat = "count", position = "fill")+
    labs(y = "Percentage of Species Age Classes",
         x = NULL,
         title = "Degree Days", tag = "A")+
    scale_fill_viridis_d(begin = 0.05, end = 0.9, option = "C")+
    scale_y_continuous(expand = c(0,0))+
    theme_bw()+
    theme(legend.position = "none")
)

```

Degree day increases and decreases by age class
```{r}
(dd.age.synthesis.plot <- ggplot(data = brt.synthesis %>% 
                               filter(dd_relinf == "Yes") %>% 
                               mutate(Age = as.factor(Age)),
                             aes(x = `Thermal Guild`,
                                 fill = Age, Color = Age))+
    geom_bar(stat = "count", position = "fill")+
    facet_wrap(~`Degree Days`)+
    labs(y = "Percentage of Species Age Classes",
         #title = "Degree Days", 
         tag = "C")+
    scale_fill_viridis_d()+
    scale_y_continuous(expand = c(0,0))+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none")
)
```
Degree day increases and decreases by life stage
```{r}
(dd.life.stage.synthesis.plot <- ggplot(data = brt.synthesis %>% 
                               filter(dd_relinf == "Yes") %>% 
                               mutate(Age = as.factor(Age)),
                             aes(x = `Thermal Guild`,
                                 fill = Life_Stage, Color = Life_Stage))+
    geom_bar(stat = "count", position = "fill")+
    facet_wrap(~`Degree Days`)+
    labs(y = "Percentage of Species Age Classes",
         #title = "Degree Days", 
         tag = "C")+
    scale_fill_viridis_d()+
    scale_y_continuous(expand = c(0,0))+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none")
)
```

Surface temperature synthesis plot
```{r}
(surf.temp.synthesis.plot <- ggplot(data = brt.synthesis %>% 
                               filter(temp_relinf == "Yes") %>% 
                             mutate(`Direction of Change` = `Surface Temperature`),
                             aes(x = `Thermal Guild`,
                                 fill = `Direction of Change`, Color = `Direction of Change`))+
    geom_bar(stat = "count", position = "fill")+
    labs(y = NULL,
         x = NULL,
         title = "Surface Temperature", tag = "B")+
    scale_fill_viridis_d(begin = 0.05, end = 0.9, option = "C")+
    scale_y_continuous(expand = c(0,0))+
    theme_bw()
)
```

Surface temperature increases and decreases by age class
```{r}
(surf.temp.age.synthesis.plot <- ggplot(data = brt.synthesis %>% 
                               filter(temp_relinf == "Yes") %>% 
                               mutate(Age = as.factor(Age)),
                             aes(x = `Thermal Guild`,
                                 fill = Age, Color = Age))+
    geom_bar(stat = "count", position = "fill")+
    facet_wrap(~`Degree Days`)+
    labs(y = NULL,
         #title = "Surface Temperature", 
         tag = "D")+
    scale_fill_viridis_d()+
    scale_y_continuous(expand = c(0,0))+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.text = element_text(size = 8), legend.key.size = unit(3, "mm"))
)

```

Surface temperature increases and decreases by life stage
```{r}
(surf.temp.life.stage.synthesis.plot <- ggplot(data = brt.synthesis %>% 
                               filter(temp_relinf == "Yes") %>% 
                               mutate(Age = as.factor(Age)),
                             aes(x = `Thermal Guild`,
                                 fill = Life_Stage, Color = Life_Stage))+
    geom_bar(stat = "count", position = "fill")+
    facet_wrap(~`Degree Days`)+
    labs(y = NULL,
         #title = "Surface Temperature", 
         tag = "D")+
    scale_fill_viridis_d()+
    scale_y_continuous(expand = c(0,0))+
    guides(fill = guide_legend(title = "Life Stage"))+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.text = element_text(size = 8), legend.key.size = unit(3, "mm"))
)

```

Stack plots
```{r}
synthesis.all.stacked <- ggarrange(dd.synthesis.plot, surf.temp.synthesis.plot,
                                   dd.life.stage.synthesis.plot, surf.temp.life.stage.synthesis.plot,
                                   nrow = 2, ncol = 2
)

synthesis.all.stacked

# ggsave("~/GitHub/EAGER_growth/Outputs/Figures/all_brt_synthesis_proportions.tiff",
#        synthesis.all.stacked,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")
```



####Counts
Degree days number of age classes increasing or decreasing w/ increasing DD
```{r}
#generate degree days plot
(dd.synthesis.count.plot <- ggplot(data = brt.synthesis %>% 
                               filter(dd_relinf == "Yes") %>% 
                             mutate(`Direction of Change` = `Degree Days`),
                             aes(x = `Thermal Guild`,
                                 fill = `Direction of Change`, Color = `Direction of Change`))+
    geom_bar(stat = "count", position = "stack")+
    labs(y = "Number of Species Age Classes",
         x = NULL,
         title = "Degree Days", tag = "A")+
    scale_fill_viridis_d(begin = 0.05, end = 0.9, option = "C")+
    scale_y_continuous(expand = c(0,0))+
    theme_bw()+
    theme(legend.position = "none")
)

```

Degree day increases and decreases by age class
```{r}
(dd.age.synthesis.count.plot <- ggplot(data = brt.synthesis %>% 
                               filter(dd_relinf == "Yes") %>% 
                               mutate(Age = as.factor(Age)),
                             aes(x = `Thermal Guild`,
                                 fill = Age, Color = Age))+
    geom_bar(stat = "count", position = "stack")+
    facet_wrap(~`Degree Days`)+
    labs(y = "Number of Species Age Classes",
         #title = "Degree Days", 
         tag = "C")+
    scale_fill_viridis_d()+
    scale_y_continuous(expand = c(0,0))+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none")
)
```

Degree day increases and decreases by life stage
```{r}
(dd.life.stage.synthesis.count.plot <- ggplot(data = brt.synthesis %>% 
                               filter(dd_relinf == "Yes") %>% 
                               mutate(Age = as.factor(Age)),
                             aes(x = `Thermal Guild`,
                                 fill = Life_Stage, Color = Life_Stage))+
    geom_bar(stat = "count", position = "stack")+
    facet_wrap(~`Degree Days`)+
    labs(y = "Number of Species Age Classes",
         #title = "Degree Days", 
         tag = "C")+
    scale_fill_viridis_d()+
    scale_y_continuous(expand = c(0,0))+
    guides(fill = guide_legend(title = "Life Stage"))+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none")
)
```

Surface temperature synthesis plot
```{r}
(surf.temp.synthesis.count.plot <- ggplot(data = brt.synthesis %>% 
                               filter(temp_relinf == "Yes") %>% 
                             mutate(`Direction of Change` = `Surface Temperature`),
                             aes(x = `Thermal Guild`,
                                 fill = `Direction of Change`, Color = `Direction of Change`))+
    geom_bar(stat = "count", position = "stack")+
    labs(y = NULL,
         x = NULL,
         title = "Surface Temperature", 
         #tag = "B",
         tag = "A")+
    scale_fill_viridis_d(begin = 0.05, end = 0.9, option = "C")+
    scale_y_continuous(expand = c(0,0))+
    theme_bw()
)
```

Surface temperature increases and decreases by age class
```{r}
(surf.temp.age.synthesis.count.plot <- ggplot(data = brt.synthesis %>% 
                               filter(temp_relinf == "Yes") %>% 
                               mutate(Age = as.factor(Age)),
                             aes(x = `Thermal Guild`,
                                 fill = Age, Color = Age))+
    geom_bar(stat = "count", position = "stack")+
    facet_wrap(~`Degree Days`)+
    labs(y = NULL,
         #title = "Surface Temperature", 
         tag = "D")+
    scale_fill_viridis_d()+
    scale_y_continuous(expand = c(0,0))+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.text = element_text(size = 8), legend.key.size = unit(3, "mm"))
)

```
Surface temperature increases and decreases by life stage
```{r}
(surf.temp.life.stage.synthesis.count.plot <- ggplot(data = brt.synthesis %>% 
                               filter(temp_relinf == "Yes") %>% 
                               mutate(Age = as.factor(Age)),
                             aes(x = `Thermal Guild`,
                                 fill = Life_Stage, Color = Life_Stage))+
    geom_bar(stat = "count", position = "stack")+
    facet_wrap(~`Degree Days`)+
    labs(y = NULL,
         #title = "Surface Temperature", 
         #tag = "D"
         tag = "B")+
    scale_fill_viridis_d()+
    scale_y_continuous(expand = c(0,0))+
    guides(fill = guide_legend(title = "Life Stage"))+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.text = element_text(size = 8), legend.key.size = unit(3, "mm"))
)

```

Stack plots
```{r}
synthesis.all.count.stacked <- ggarrange(dd.synthesis.count.plot, surf.temp.synthesis.count.plot,
                                   dd.life.stage.synthesis.count.plot, surf.temp.life.stage.synthesis.count.plot,
                                   nrow = 2, ncol = 2
)

synthesis.all.count.stacked

# ggsave("~/GitHub/EAGER_growth/Outputs/Figures/all_brt_synthesis_counts.tiff",
#        synthesis.all.count.stacked,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")
```

Life Stage flip and multipanel
```{r}
#reformat data
brt.synthesis.dd.summary <- brt.synthesis %>% 
  filter(dd_relinf == "Yes",
         !(Species == "Black Crappie" & Age == 0),
                                            !(Species == "Bluegill" & Age %in% c(0, 11)),
                                            !(Species == "Yellow Perch" & Age == 11),
                                            !(Species == "Brown Trout" & Age == 5)
         ) %>% 
  group_by(`Thermal Guild`, Life_Stage, `Degree Days`) %>% 
  summarise(freq = n(), .groups = "drop") %>% 
  rename(Direction = `Degree Days`) %>% 
  mutate(freq = if_else(Direction == "Decrease", -freq, freq
  ))

brt.synthesis.temp.summary <- brt.synthesis %>% 
  filter(temp_relinf == "Yes",
         !(Species == "Black Crappie" & Age == 0),
                                            !(Species == "Bluegill" & Age %in% c(0, 11)),
                                            !(Species == "Yellow Perch" & Age == 11),
                                            !(Species == "Brown Trout" & Age == 5)
         ) %>% 
  group_by(`Thermal Guild`, Life_Stage, `Surface Temperature`) %>% 
  summarise(freq = n(), .groups = "drop") %>% 
  rename(Direction = `Surface Temperature`) %>% 
  mutate(freq = if_else(Direction == "Decrease", -freq, freq
  ))

(surf.temp.synthesis.count.plot.flip <- ggplot(data = brt.synthesis.temp.summary,
                             aes(x = `Thermal Guild`, y = freq,
                                 fill = Life_Stage, Color = Life_Stage))+
    geom_col()+
    labs(y = NULL,
         #x = NULL,
         title = "Surface Temperature", 
         #tag = "B",
         tag = "A")+
    scale_fill_viridis_d(begin = 0.05, end = 0.9, option = "C")+
    scale_x_discrete(limits = c("Cold", "Cool", "Warm"))+
    scale_y_continuous(
        limits = c(-45,45), 
        n.breaks = 10,
        labels = function(x) abs(x)
    )+
    coord_flip()+
    geom_hline(yintercept = 0, col = "black")+
    #decreasing arrow
    geom_segment(aes(y = -15, x = 0.75, yend = -40, xend = 0.75),
               arrow = arrow(length = unit(0.2, "inches")),
               color = "black", size = 2) +
    #increasing arrow
    geom_segment(aes(y = 15, x = 0.75, yend = 40, xend = 0.75),
               arrow = arrow(length = unit(0.2, "inches")),
               color = "black", size = 2) +
    annotate(geom = "text", label = "Decreasing", y = -25, x = 1.25)+
    annotate(geom = "text", label = "Increasing", y = 25, x = 1.25)+
    theme_bw()+
    guides(fill = guide_legend(title = "Life Stage"))
)


(dd.synthesis.count.plot.flip <- ggplot(data = brt.synthesis.dd.summary,
                             aes(x = `Thermal Guild`, y = freq,
                                 fill = Life_Stage, Color = Life_Stage))+
    geom_col()+
    labs(y = "Number of Age Classes",
         title = "Degree Days", 
         tag = "B")+
    scale_fill_viridis_d(begin = 0.05, end = 0.9, option = "C")+
    scale_x_discrete(limits = c("Cold", "Cool", "Warm"))+
    scale_y_continuous(
        limits = c(-45,45), 
        n.breaks = 10,
        labels = function(x) abs(x)
    )+
    coord_flip()+
    geom_hline(yintercept = 0, col = "black")+
    #decreasing arrow
    geom_segment(aes(y = -15, x = 0.75, yend = -40, xend = 0.75),
               arrow = arrow(length = unit(0.2, "inches")),
               color = "black", size = 2) +
    #increasing arrow
    geom_segment(aes(y = 15, x = 0.75, yend = 40, xend = 0.75),
               arrow = arrow(length = unit(0.2, "inches")),
               color = "black", size = 2) +
    annotate(geom = "text", label = "Decreasing", y = -25, x = 1.25)+
    annotate(geom = "text", label = "Increasing", y = 25, x = 1.25)+
    theme_bw()+
    guides(fill = guide_legend(title = "Life Stage"))
)

synthesis.all.life.stage.opposite.bars <- ggarrange(surf.temp.synthesis.count.plot.flip,
                                                    dd.synthesis.count.plot.flip,
                                   nrow = 2, ncol = 1, common.legend = T, legend = "right"
)

synthesis.all.life.stage.opposite.bars

ggsave("~/GitHub/EAGER_growth/Outputs/Figures/all_brt_synthesis_life_stage_opposite_bars.tiff",
       synthesis.all.life.stage.opposite.bars,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```
##Relative Influence Plot
```{r}
species.colors <- c(
  #Three cold-water species
  "#30123BFF", "#3A2C78FF", "#4145AAFF",
  #Six cool-water species
  "#18DBC5FF", "#1FE9AFFF", "#34F395FF", "#54FA78FF", "#76FE5BFF", "#96FE44FF",
  #Four warm-water species
  "#F7C13AFF", "#F25F14FF", "#C62703FF", "#7A0403FF"
  )

#create plot data
all.spp.rel.inf.plot.data <- all.spp.response.matrix %>% 
  dplyr::distinct(Species, Predictor_Name, .keep_all = T) %>% 
  mutate(Predictor_Name = fct_reorder(Predictor_Name, mean_rel_inf, .desc = T),
         `Thermal Guild` = fct_relevel(`Thermal Guild`, "Cold", "Cool", "Warm"),
         Species = fct_relevel(Species, "Cisco", "Rainbow Trout", "Brown Trout", "Yellow Perch",
                                           "Northern Pike", "Walleye", "White Sucker", "Black Crappie", 
                                           "Rock Bass", "Smallmouth Bass", "Pumpkinseed Sunfish",
                                           "Largemouth Bass", "Bluegill"))

#summary plot
(all.spp.rel.inf.plot <- ggplot(data = all.spp.rel.inf.plot.data, 
                                aes(x = Predictor_Name, y = mean_rel_inf, 
                                    group  = Predictor_Name, fill = Species,
                                    shape = `Thermal Guild`))+
    geom_hline(aes(yintercept = 10), color = "red", linetype = "dashed")+
    geom_boxplot(outliers = F)+
    geom_jitter(size = 2)+
    labs(y = "Relative Influence", x = "Predictor")+
    scale_fill_manual(values = species.colors)+
    scale_shape_manual(values = c(21, 22, 23))+
    theme_bw()+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  )

ggsave("~/GitHub/EAGER_growth/Outputs/Figures/all_spp_rel_influence.tiff",
       all.spp.rel.inf.plot,
       dpi = 300,
       width = 200,
       height = 150,
       units = "mm")
```

Facet by age class - right now mean_rel_inf is a species mean
```{r}
# (all.spp.rel.inf.plot.age.facet <- ggplot(data = all.spp.rel.inf.plot.data, 
#                                           aes(x = Predictor_Name, y = mean_rel_inf))+
#     geom_boxplot()+
#     facet_wrap(~Age_Group)+
#     theme_bw()+
#     theme(axis.text.x = element_text(angle = 45, hjust = 1))
#   
#   )
# 
# ggsave("~/GitHub/EAGER_growth/Outputs/Figures/all_spp_rel_influence_age_facet.tiff",
#        all.spp.rel.inf.plot.age.facet,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")
```

Facet by Predictor Name
```{r}
# (all.spp.rel.inf.plot.predictor.facet <- ggplot(data = all.spp.rel.inf.plot.data, 
#                                 aes(x = Age_Group, y = mean_rel_inf, 
#                                     group  = Age_Group, fill = `Thermal Guild`))+
#     geom_boxplot()+
#     geom_point(shape = 21)+
#     labs(y = "Relative Influence", x = "Predictor")+
#     scale_fill_viridis_d()+
#     facet_wrap(~Predictor_Name, scales = "free")+
#     theme_bw()+
#     theme(axis.text.x = element_text(angle = 45, hjust = 1))
#   
#   )
# 
# ggsave("~/GitHub/EAGER_growth/Outputs/Figures/all_spp_rel_influence_predictor_facet.tiff",
#        all.spp.rel.inf.plot.predictor.facet,
#        dpi = 300,
#        width = 200,
#        height = 150,
#        units = "mm")
```

###Combined Model Performance Table
```{r}
all.model.performance <- 
  bind_cols(
    #Black Crappie
    ggPerformance(bc0_brt) %>% rename(bc_0 = `Model 1`),
    ggPerformance(bc1_brt) %>% rename(bc_1 = `Model 1`),
    ggPerformance(bc2_brt) %>% rename(bc_2 = `Model 1`),
    ggPerformance(bc3_brt) %>% rename(bc_3 = `Model 1`),
    ggPerformance(bc4_brt) %>% rename(bc_4 = `Model 1`),
    ggPerformance(bc5_brt) %>% rename(bc_5 = `Model 1`),
    ggPerformance(bc6_brt) %>% rename(bc_6 = `Model 1`),
    ggPerformance(bc7_brt) %>% rename(bc_7 = `Model 1`),
    ggPerformance(bc8_brt) %>% rename(bc_8 = `Model 1`),
    ggPerformance(bc9_brt) %>% rename(bc_9 = `Model 1`),
    ggPerformance(bc10_brt) %>% rename(bc_10 = `Model 1`),
    ggPerformance(bc11_brt) %>% rename(bc_11 = `Model 1`),
    #White Sucker
    ggPerformance(catcom1_brt) %>% rename(catcom_1 = `Model 1`),
    ggPerformance(catcom2_brt) %>% rename(catcom_2 = `Model 1`),
    ggPerformance(catcom3_brt) %>% rename(catcom_3 = `Model 1`),
    ggPerformance(catcom4_brt) %>% rename(catcom_4 = `Model 1`),
    ggPerformance(catcom5_brt) %>% rename(catcom_5 = `Model 1`),
    #Cisco
    ggPerformance(corart2_brt) %>% rename(corart_2 = `Model 1`),
    ggPerformance(corart3_brt) %>% rename(corart_3 = `Model 1`),
    ggPerformance(corart4_brt) %>% rename(corart_4 = `Model 1`),
    ggPerformance(corart5_brt) %>% rename(corart_5 = `Model 1`),
    ggPerformance(corart6_brt) %>% rename(corart_6 = `Model 1`),
    ggPerformance(corart7_brt) %>% rename(corart_7 = `Model 1`),
    #Northern Pike
    ggPerformance(esoluc0_brt) %>% rename(esoluc_0 = `Model 1`),
    ggPerformance(esoluc1_brt) %>% rename(esoluc_1 = `Model 1`),
    ggPerformance(esoluc2_brt) %>% rename(esoluc_2 = `Model 1`),
    ggPerformance(esoluc3_brt) %>% rename(esoluc_3 = `Model 1`),
    ggPerformance(esoluc4_brt) %>% rename(esoluc_4 = `Model 1`),
    ggPerformance(esoluc5_brt) %>% rename(esoluc_5 = `Model 1`),
    ggPerformance(esoluc6_brt) %>% rename(esoluc_6 = `Model 1`),
    ggPerformance(esoluc7_brt) %>% rename(esoluc_7 = `Model 1`),
    ggPerformance(esoluc8_brt) %>% rename(esoluc_8 = `Model 1`),
    ggPerformance(esoluc9_brt) %>% rename(esoluc_9 = `Model 1`),
    ggPerformance(esoluc10_brt) %>% rename(esoluc_10 = `Model 1`),
    #Bluegill
    ggPerformance(lepmac0_brt) %>% rename(lepmac_0 = `Model 1`),
    ggPerformance(lepmac1_brt) %>% rename(lepmac_1 = `Model 1`),
    ggPerformance(lepmac2_brt) %>% rename(lepmac_2 = `Model 1`),
    ggPerformance(lepmac3_brt) %>% rename(lepmac_3 = `Model 1`),
    ggPerformance(lepmac4_brt) %>% rename(lepmac_4 = `Model 1`),
    ggPerformance(lepmac5_brt) %>% rename(lepmac_5 = `Model 1`),
    ggPerformance(lepmac6_brt) %>% rename(lepmac_6 = `Model 1`),
    ggPerformance(lepmac7_brt) %>% rename(lepmac_7 = `Model 1`),
    ggPerformance(lepmac8_brt) %>% rename(lepmac_8 = `Model 1`),
    ggPerformance(lepmac9_brt) %>% rename(lepmac_9 = `Model 1`),
    ggPerformance(lepmac10_brt) %>% rename(lepmac_10 = `Model 1`),
    ggPerformance(lepmac11_brt) %>% rename(lepmac_11 = `Model 1`),
    #Smallmouth Bass
    ggPerformance(micdol0_brt) %>% rename(micdol_0 = `Model 1`),
    ggPerformance(micdol1_brt) %>% rename(micdol_1 = `Model 1`),
    ggPerformance(micdol2_brt) %>% rename(micdol_2 = `Model 1`),
    ggPerformance(micdol3_brt) %>% rename(micdol_3 = `Model 1`),
    ggPerformance(micdol4_brt) %>% rename(micdol_4 = `Model 1`),
    ggPerformance(micdol5_brt) %>% rename(micdol_5 = `Model 1`),
    ggPerformance(micdol6_brt) %>% rename(micdol_6 = `Model 1`),
    ggPerformance(micdol7_brt) %>% rename(micdol_7 = `Model 1`),
    ggPerformance(micdol8_brt) %>% rename(micdol_8 = `Model 1`),
    ggPerformance(micdol9_brt) %>% rename(micdol_9 = `Model 1`),
    ggPerformance(micdol10_brt) %>% rename(micdol_10 = `Model 1`),
    #Largemouth Bass
    ggPerformance(micsal0_brt) %>% rename(micsal_0 = `Model 1`),
    ggPerformance(micsal1_brt) %>% rename(micsal_1 = `Model 1`),
    ggPerformance(micsal2_brt) %>% rename(micsal_2 = `Model 1`),
    ggPerformance(micsal3_brt) %>% rename(micsal_3 = `Model 1`),
    ggPerformance(micsal4_brt) %>% rename(micsal_4 = `Model 1`),
    ggPerformance(micsal5_brt) %>% rename(micsal_5 = `Model 1`),
    ggPerformance(micsal6_brt) %>% rename(micsal_6 = `Model 1`),
    ggPerformance(micsal7_brt) %>% rename(micsal_7 = `Model 1`),
    ggPerformance(micsal8_brt) %>% rename(micsal_8 = `Model 1`),
    ggPerformance(micsal9_brt) %>% rename(micsal_9 = `Model 1`),
    ggPerformance(micsal10_brt) %>% rename(micsal_10 = `Model 1`),
    ggPerformance(micsal11_brt) %>% rename(micsal_11 = `Model 1`),
    ggPerformance(micsal12_brt) %>% rename(micsal_12 = `Model 1`),
    #Rainbow Trout
    ggPerformance(oncmyk1_brt) %>% rename(oncmyk_1 = `Model 1`),
    ggPerformance(oncmyk2_brt) %>% rename(oncmyk_2 = `Model 1`),
    ggPerformance(oncmyk3_brt) %>% rename(oncmyk_3 = `Model 1`),
    ggPerformance(oncmyk4_brt) %>% rename(oncmyk_4 = `Model 1`),
    #Yellow Perch
    ggPerformance(perfla0_brt) %>% rename(perfla_0 = `Model 1`),
    ggPerformance(perfla1_brt) %>% rename(perfla_1 = `Model 1`),
    ggPerformance(perfla2_brt) %>% rename(perfla_2 = `Model 1`),
    ggPerformance(perfla3_brt) %>% rename(perfla_3 = `Model 1`),
    ggPerformance(perfla4_brt) %>% rename(perfla_4 = `Model 1`),
    ggPerformance(perfla5_brt) %>% rename(perfla_5 = `Model 1`),
    ggPerformance(perfla6_brt) %>% rename(perfla_6 = `Model 1`),
    ggPerformance(perfla7_brt) %>% rename(perfla_7 = `Model 1`),
    ggPerformance(perfla8_brt) %>% rename(perfla_8 = `Model 1`),
    ggPerformance(perfla9_brt) %>% rename(perfla_9 = `Model 1`),
    ggPerformance(perfla10_brt) %>% rename(perfla_10 = `Model 1`),
    ggPerformance(perfla11_brt) %>% rename(perfla_11 = `Model 1`),
    #Pumpkinseed Sunfish
    ggPerformance(psf1_brt) %>% rename(psf_1 = `Model 1`),
    ggPerformance(psf2_brt) %>% rename(psf_2 = `Model 1`),
    ggPerformance(psf3_brt) %>% rename(psf_3 = `Model 1`),
    ggPerformance(psf4_brt) %>% rename(psf_4 = `Model 1`),
    ggPerformance(psf5_brt) %>% rename(psf_5 = `Model 1`),
    ggPerformance(psf6_brt) %>% rename(psf_6 = `Model 1`),
    ggPerformance(psf7_brt) %>% rename(psf_7 = `Model 1`),
    ggPerformance(psf8_brt) %>% rename(psf_8 = `Model 1`),
    ggPerformance(psf9_brt) %>% rename(psf_9 = `Model 1`),
    #Rockbass
    ggPerformance(rb1_brt) %>% rename(rb_1 = `Model 1`),
    ggPerformance(rb2_brt) %>% rename(rb_2 = `Model 1`),
    ggPerformance(rb3_brt) %>% rename(rb_3 = `Model 1`),
    ggPerformance(rb4_brt) %>% rename(rb_4 = `Model 1`),
    ggPerformance(rb5_brt) %>% rename(rb_5 = `Model 1`),
    ggPerformance(rb6_brt) %>% rename(rb_6 = `Model 1`),
    ggPerformance(rb7_brt) %>% rename(rb_7 = `Model 1`),
    ggPerformance(rb8_brt) %>% rename(rb_8 = `Model 1`),
    ggPerformance(rb9_brt) %>% rename(rb_9 = `Model 1`),
    ggPerformance(rb10_brt) %>% rename(rb_10 = `Model 1`),
    ggPerformance(rb11_brt) %>% rename(rb_11 = `Model 1`),
    #Brown Trout
    ggPerformance(saltru1_brt) %>% rename(saltru_1 = `Model 1`),
    ggPerformance(saltru2_brt) %>% rename(saltru_2 = `Model 1`),
    ggPerformance(saltru3_brt) %>% rename(saltru_3 = `Model 1`),
    ggPerformance(saltru4_brt) %>% rename(saltru_4 = `Model 1`),
    ggPerformance(saltru5_brt) %>% rename(saltru_5 = `Model 1`),
    #Walleye
    ggPerformance(wae0_brt) %>% rename(wae_0 = `Model 1`),
    ggPerformance(wae1_brt) %>% rename(wae_1 = `Model 1`),
    ggPerformance(wae2_brt) %>% rename(wae_2 = `Model 1`),
    ggPerformance(wae3_brt) %>% rename(wae_3 = `Model 1`),
    ggPerformance(wae4_brt) %>% rename(wae_4 = `Model 1`),
    ggPerformance(wae5_brt) %>% rename(wae_5 = `Model 1`),
    ggPerformance(wae6_brt) %>% rename(wae_6 = `Model 1`),
    ggPerformance(wae7_brt) %>% rename(wae_7 = `Model 1`),
    ggPerformance(wae8_brt) %>% rename(wae_8 = `Model 1`),
    ggPerformance(wae9_brt) %>% rename(wae_9 = `Model 1`),
    ggPerformance(wae10_brt) %>% rename(wae_10 = `Model 1`),
    ggPerformance(wae11_brt) %>% rename(wae_11 = `Model 1`),
    ggPerformance(wae12_brt) %>% rename(wae_12 = `Model 1`)
  ) %>% 
  t() %>% as.data.frame() %>% 
  rownames_to_column(var = "Spp_Age") %>% 
  separate(Spp_Age, into = c("Species", "Age_Class"), sep = "_") %>% 
  mutate(Species = case_when(
    Species == "bc" ~ "Black Crappie", 
    Species == "catcom" ~ "White Sucker",
    Species == "corart" ~ "Cisco",
    Species == "esoluc" ~ "Northern Pike",
    Species == "lepmac" ~ "Bluegill",
    Species == "micdol" ~ "Smallmouth Bass",
    Species == "micsal" ~ "Largemouth Bass",
    Species ==  "oncmyk" ~ "Rainbow Trout",
    Species == "perfla" ~ "Yellow Perch",
    Species == "psf" ~ "Pumpkinseed Sunfish",
    Species == "rb" ~ "Rock Bass",
    Species == "saltru" ~ "Brown Trout",
    Species == "wae" ~ "Walleye"
  ))

write.xlsx(all.model.performance,
           file = "~/GitHub/EAGER_growth/Outputs/Tables/brt_all_model_performance.xlsx")

mean(all.model.performance$Per.Expl)

```

